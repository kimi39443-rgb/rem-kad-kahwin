<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Jemputan</title>
  <style>
    :root{
      --glass: rgba(255,255,255,.10);
      --glass2: rgba(255,255,255,.08);
      --line: rgba(255,255,255,.14);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --btn: rgba(255,255,255,.14);
      --accent: rgba(144,172,255,.95);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#000;color:#fff;min-height:100vh;overflow-x:hidden}
    /* video bg */
    #bgVideo{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:-2;background:#000}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:-1}
    /* layout */
    .wrap{min-height:100vh;padding:18px 14px 92px;display:flex;align-items:flex-start;justify-content:center}
    .card{width:min(560px,100%);background:var(--glass);border:1px solid var(--line);border-radius:22px;padding:16px 14px;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);box-shadow:0 24px 70px rgba(0,0,0,.45)}
    .top{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:12px}
    .topL{display:flex;flex-direction:column}
    .topTitle{font-weight:800;font-size:18px;letter-spacing:.2px}
    .topSub{opacity:.8;font-size:13px;margin-top:2px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:10px 12px;border-radius:999px;background:var(--glass2);border:1px solid var(--line);font-size:13px;opacity:.9}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:var(--glass2);border:1px solid var(--line);font-size:12px;letter-spacing:1px;text-transform:uppercase;opacity:.9}
    h1{margin:10px 0 6px;font-size:34px;letter-spacing:.2px}
    .msg{opacity:.9;line-height:1.6;margin:0 0 14px}
    .couple{margin:10px 0 14px;padding:14px 14px;border-radius:18px;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.10);font-weight:900;font-size:28px;text-align:center}
    .btn{width:100%;display:flex;gap:10px;align-items:center;justify-content:center;padding:14px 14px;border-radius:16px;border:1px solid var(--line);background:var(--btn);color:#fff;font-weight:900;font-size:16px;text-decoration:none}
    .btn.primary{background:var(--accent);border-color:rgba(255,255,255,.18);color:#0b0b0e}
    .btnRow{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    .btnRow .btn{font-size:15px}
    .hr{height:1px;background:rgba(255,255,255,.12);margin:14px 0}
    .section{background:rgba(0,0,0,.16);border:1px solid rgba(255,255,255,.10);border-radius:18px;padding:14px}
    .secTitle{font-weight:900;font-size:18px;margin:0 0 10px}
    .kv{display:grid;grid-template-columns:120px 1fr;gap:8px 10px;align-items:start}
    .k{opacity:.75;font-size:13px}
    .v{font-weight:700}
    .count{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
    .box{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:12px;text-align:center}
    .num{font-weight:950;font-size:26px}
    .lab{opacity:.75;font-size:12px;margin-top:4px;letter-spacing:.6px}
    .note{opacity:.75;font-size:12px;line-height:1.5;margin-top:10px}
    /* bottom nav (optional placeholder) */
    .nav{position:fixed;left:0;right:0;bottom:0;padding:10px 10px 18px;background:linear-gradient(to top, rgba(0,0,0,.65), rgba(0,0,0,0));display:flex;justify-content:center}
    .navInner{width:min(560px,100%);display:flex;gap:8px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:8px}
    .tab{flex:1;text-align:center;padding:10px 8px;border-radius:14px;color:#fff;text-decoration:none;font-weight:800;opacity:.85}
    .tab.active{background:rgba(144,172,255,.22);border:1px solid rgba(144,172,255,.35);opacity:1}
    /* Tap to play */
    #tapToPlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:20;background:rgba(0,0,0,.75);padding:18px}
    .tapCard{width:min(520px,100%);background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);border-radius:18px;padding:18px 16px;text-align:center;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}
    .tapTitle{font-weight:900;font-size:18px;margin:0 0 6px}
    .tapDesc{opacity:.85;font-size:13px;line-height:1.5;margin:0 0 12px}
    .tapBtn{padding:12px 16px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.14);color:#fff;font-weight:900}
    /* VIP gate */
    #vipGate{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:30;background:rgba(0,0,0,.75);padding:18px}
    .vipCard{width:min(520px,100%);background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);border-radius:18px;padding:18px 16px}
    .vipPill{display:inline-flex;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.14);font-size:12px;letter-spacing:1px;text-transform:uppercase;opacity:.9}
    .vipH{margin:10px 0 6px;font-size:20px;font-weight:950}
    .vipT{margin:0 0 12px;opacity:.85;line-height:1.5;font-size:13px}
    .vipIn{width:100%;padding:12px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.18);color:#fff;font-weight:800;outline:none}
    .vipRow{display:flex;gap:10px;margin-top:12px}
    .vipRow button{flex:1;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.12);color:#fff;font-weight:900}
    .vipRow button.primary{background:var(--accent);color:#0b0b0e}
    /* warning */
    .warn{margin:0 0 10px;padding:10px 12px;border-radius:14px;background:rgba(255,180,60,.16);border:1px solid rgba(255,180,60,.28);font-size:13px;line-height:1.5;color:rgba(255,255,255,.92)}
  </style>
</head>
<body>

  <!-- Video BG (optional) -->
  <video id="bgVideo" muted loop playsinline preload="auto">
    <source src="assets/bg.mp4" type="video/mp4" />
  </video>
  <div class="overlay"></div>

  <div id="tapToPlay">
    <div class="tapCard">
      <p class="tapTitle">Ketik untuk mula</p>
      <p class="tapDesc">Sesetengah Chrome/Android perlukan satu sentuhan untuk main video.</p>
      <button class="tapBtn" id="tapBtn">Mulakan</button>
    </div>
  </div>

  <div id="vipGate">
    <div class="vipCard">
      <span class="vipPill">VIP Only</span>
      <div class="vipH">Jemputan ini memerlukan kod VIP</div>
      <p class="vipT">Masukkan kod VIP yang diberi. (Kod diset dalam admin panel)</p>
      <input class="vipIn" id="vipInput" placeholder="Contoh: VIP123" />
      <div class="vipRow">
        <button id="vipBack">Kembali</button>
        <button class="primary" id="vipOpen">Buka Jemputan</button>
      </div>
      <div class="note" id="vipTip"></div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">

      <div class="top">
        <div class="topL">
          <div class="topTitle" id="topTitle">Kad Kahwin Digital</div>
          <div class="topSub" id="topSub">Jemputan Rasmi</div>
        </div>
        <div class="pill" id="guestPill">üë§ <span id="guestName">Tetamu</span></div>
      </div>

      <div id="warnBox" class="warn" style="display:none"></div>

      <span class="badge" id="badgeTxt">WEDDING INVITATION</span>
      <h1 id="invTitle">Walimatul Urus</h1>
      <p class="msg" id="invMsg">Dengan penuh kesyukuran, kami menjemput anda hadir memeriahkan majlis perkahwinan kami.</p>

      <div class="couple" id="invCouple">Adam &amp; Hawa</div>

      <a class="btn primary" id="btnRsvp" href="#" target="_blank" rel="noopener">‚úâÔ∏è RSVP Sekarang</a>

      <div class="btnRow">
        <a class="btn" id="btnMaps" href="#" target="_blank" rel="noopener">üìç Lihat Lokasi</a>
        <a class="btn" id="btnCal" href="#" target="_blank" rel="noopener">üóìÔ∏è Add to Calendar</a>
      </div>

      <div style="margin-top:10px">
        <a class="btn" id="btnShare" href="javascript:void(0)">üîó Share</a>
      </div>

      <div class="note" id="noticeTxt" style="margin-top:10px;opacity:.8">
        Notis: Dilarang guna/jual page ini tanpa kebenaran pemilik.
      </div>

      <div class="hr"></div>

      <div class="section">
        <div class="secTitle">Maklumat Majlis</div>
        <div class="kv">
          <div class="k">Tarikh</div><div class="v" id="invDate">01/12/2025</div>
          <div class="k">Masa</div><div class="v" id="invTime">9.00am ‚Äì 2.00pm</div>
          <div class="k">Tempat</div><div class="v" id="invVenue">Dewan Serbaguna</div>
          <div class="k">Alamat</div><div class="v" id="invAddr">Alamat ringkas majlis di sini</div>
        </div>

        <div style="margin-top:14px;font-weight:900;opacity:.92">Countdown ke hari majlis</div>
        <div class="count">
          <div class="box"><div class="num" id="cdD">0</div><div class="lab">HARI</div></div>
          <div class="box"><div class="num" id="cdH">00</div><div class="lab">JAM</div></div>
          <div class="box"><div class="num" id="cdM">00</div><div class="lab">MINIT</div></div>
          <div class="box"><div class="num" id="cdS">00</div><div class="lab">SAAT</div></div>
        </div>
        <div class="note" id="cdNote"></div>
      </div>

    </div>
  </div>

  <div class="nav">
    <div class="navInner">
      <a class="tab active" href="invite.html">Utama</a>
      <a class="tab" href="javascript:void(0)" onclick="scrollTo(0,0)">Maklumat</a>
      <a class="tab" href="javascript:void(0)" onclick="alert('Aturcara/Galeri boleh ditambah kemudian')">Aturcara</a>
      <a class="tab" href="javascript:void(0)" onclick="alert('Galeri boleh ditambah kemudian')">Galeri</a>
      <a class="tab" href="javascript:void(0)" onclick="document.getElementById('btnRsvp').click()">RSVP</a>
    </div>
  </div>

<script>
/* =======================
   STABIL: DATA MODEL V2
   ======================= */
const STORE_KEY = "KADKAHWIN_DATA_V2";
const DEFAULT_DATA = {
  mode: "stable", // stable | sale | personal
  videoOn: true,
  vipOn: false,
  vipCode: "VIP123",
  expiredAt: "", // "2025-12-31 23:59" (optional)
  // UI text
  topTitle:"Kad Kahwin Digital",
  topSub:"Jemputan Rasmi",
  badge:"WEDDING INVITATION",
  title:"Walimatul Urus",
  message:"Dengan penuh kesyukuran, kami menjemput anda hadir memeriahkan majlis perkahwinan kami.",
  couple:"Adam & Hawa",
  date:"01/12/2025",
  time:"9.00am ‚Äì 2.00pm",
  venue:"Dewan Serbaguna",
  address:"Alamat ringkas majlis di sini",
  maps:"https://maps.google.com/",
  rsvp:"https://wa.me/60123456789?text=Assalamualaikum,%20saya%20nak%20RSVP",
  notice:"Notis: Dilarang guna/jual page ini tanpa kebenaran pemilik."
};

const $ = (id)=>document.getElementById(id);

/* ---------- base64url decode/encode ---------- */
function b64urlDecode(str){
  try{
    str = (str||"").replace(/-/g,'+').replace(/_/g,'/');
    const pad = str.length % 4; if(pad) str += '='.repeat(4-pad);
    const json = decodeURIComponent(Array.from(atob(str)).map(c=>'%'+c.charCodeAt(0).toString(16).padStart(2,'0')).join(''));
    return JSON.parse(json);
  }catch(e){ return null; }
}
function safeParseJSON(raw){
  try{ return JSON.parse(raw); }catch(e){ return null; }
}

/* ---------- get data (URL > localStorage > default) ---------- */
function getData(){
  const url = new URL(location.href);
  const dParam = url.searchParams.get("d");
  const guest = url.searchParams.get("to") || "Tetamu";
  let data = null;

  if(dParam){
    const decoded = b64urlDecode(dParam);
    if(decoded && typeof decoded === "object") data = decoded;
  }

  if(!data){
    const saved = safeParseJSON(localStorage.getItem(STORE_KEY));
    if(saved && typeof saved === "object") data = saved;
  }

  data = Object.assign({}, DEFAULT_DATA, (data||{}));
  data.guest = guest;
  return data;
}

/* ---------- apply data ---------- */
function applyData(d){
  $("topTitle").textContent = d.topTitle || DEFAULT_DATA.topTitle;
  $("topSub").textContent = d.topSub || DEFAULT_DATA.topSub;
  $("badgeTxt").textContent = d.badge || DEFAULT_DATA.badge;

  $("invTitle").textContent = d.title || DEFAULT_DATA.title;
  $("invMsg").textContent = d.message || DEFAULT_DATA.message;
  $("invCouple").textContent = d.couple || DEFAULT_DATA.couple;

  $("invDate").textContent = d.date || DEFAULT_DATA.date;
  $("invTime").textContent = d.time || DEFAULT_DATA.time;
  $("invVenue").textContent = d.venue || DEFAULT_DATA.venue;
  $("invAddr").textContent = d.address || DEFAULT_DATA.address;

  $("noticeTxt").textContent = d.notice || DEFAULT_DATA.notice;
  $("guestName").textContent = d.guest || "Tetamu";

  // links: kalau kosong, disable
  setLink("btnMaps", d.maps);
  setLink("btnRsvp", d.rsvp);

  // calendar link
  const cal = buildGoogleCalendarLink(d);
  setLink("btnCal", cal);

  // share
  $("btnShare").onclick = ()=>shareLink(d);

  // video on/off
  const v = $("bgVideo");
  if(d.videoOn){
    v.style.display = "block";
  }else{
    v.pause?.(); v.style.display = "none";
  }
}

function setLink(id, href){
  const el = $(id);
  if(!el) return;
  if(href && String(href).trim() !== "#"){
    el.href = href;
    el.style.opacity = "1";
    el.style.pointerEvents = "auto";
  }else{
    el.href = "javascript:void(0)";
    el.style.opacity = ".55";
    el.style.pointerEvents = "none";
  }
}

/* ---------- countdown ---------- */
function parseMYDate(dateStr){
  // "DD/MM/YYYY"
  const m = (dateStr||"").match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(!m) return null;
  const dd = +m[1], mm = +m[2], yy = +m[3];
  if(!dd||!mm||!yy) return null;
  return {dd,mm,yy};
}
function parseStartTime(timeRange){
  // "9.00am ‚Äì 2.00pm" -> ambil 9.00am
  const s = (timeRange||"").split(/[‚Äì-]/)[0].trim().toLowerCase();
  // accept 9.00am / 9:00am / 9am
  const m = s.match(/^(\d{1,2})(?:[.:](\d{2}))?\s*(am|pm)$/);
  if(!m) return {hh:0, min:0};
  let hh = +m[1], min = +(m[2]||"0");
  const ap = m[3];
  if(ap==="pm" && hh<12) hh+=12;
  if(ap==="am" && hh===12) hh=0;
  return {hh, min};
}
function startCountdown(d){
  const dateObj = parseMYDate(d.date);
  if(!dateObj){ $("cdNote").textContent = ""; return; }
  const t = parseStartTime(d.time);
  const target = new Date(dateObj.yy, dateObj.mm-1, dateObj.dd, t.hh, t.min, 0, 0);

  function tick(){
    const now = new Date();
    let diff = target - now;
    if(diff <= 0){
      $("cdD").textContent="0"; $("cdH").textContent="00"; $("cdM").textContent="00"; $("cdS").textContent="00";
      $("cdNote").textContent = "Hari ini majlis üéâ";
      return;
    }
    const s = Math.floor(diff/1000);
    const dd = Math.floor(s/86400);
    const hh = Math.floor((s%86400)/3600);
    const mm = Math.floor((s%3600)/60);
    const ss = s%60;
    $("cdD").textContent = String(dd);
    $("cdH").textContent = String(hh).padStart(2,'0');
    $("cdM").textContent = String(mm).padStart(2,'0');
    $("cdS").textContent = String(ss).padStart(2,'0');
    $("cdNote").textContent = "";
    requestAnimationFrame(()=>setTimeout(tick, 250));
  }
  tick();
}

/* ---------- VIP + Expired gate ---------- */
function parseExpired(expStr){
  // "YYYY-MM-DD HH:MM"
  const m = (expStr||"").trim().match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/);
  if(!m) return null;
  return new Date(+m[1], +m[2]-1, +m[3], +m[4], +m[5], 0, 0);
}

function showWarn(msg){
  const w = $("warnBox");
  w.style.display="block";
  w.textContent = msg;
}

function vipAndExpiredCheck(d){
  // expired
  const exp = parseExpired(d.expiredAt);
  if(exp && new Date() > exp){
    showWarn("Jemputan ini telah tamat tempoh (Expired). Sila hubungi tuan rumah.");
    // disable buttons
    ["btnRsvp","btnMaps","btnCal","btnShare"].forEach(id=>{
      const el=$(id); if(!el) return;
      el.style.opacity=".55"; el.style.pointerEvents="none";
    });
    return false;
  }

  // VIP lock
  if(d.vipOn){
    const okKey = "VIP_OK_V2";
    const url = new URL(location.href);
    const vip = url.searchParams.get("vip");
    const storedOK = sessionStorage.getItem(okKey)==="1";

    if(vip && vip === d.vipCode){
      sessionStorage.setItem(okKey,"1");
      return true;
    }
    if(storedOK) return true;

    // show gate
    $("vipGate").style.display="flex";
    $("vipTip").textContent = "Tip: kod VIP boleh dihantar kepada tetamu melalui WhatsApp.";
    $("vipBack").onclick = ()=>history.length>1 ? history.back() : (location.href="index.html");
    $("vipOpen").onclick = ()=>{
      const val = ($("vipInput").value||"").trim();
      if(val === d.vipCode){
        sessionStorage.setItem(okKey,"1");
        $("vipGate").style.display="none";
      }else{
        alert("Kod VIP salah.");
      }
    };
    return false;
  }

  return true;
}

/* ---------- calendar link ---------- */
function buildGoogleCalendarLink(d){
  // buat event simple (Google Calendar template)
  const dateObj = parseMYDate(d.date);
  if(!dateObj) return "";
  const t = parseStartTime(d.time);
  const start = new Date(dateObj.yy, dateObj.mm-1, dateObj.dd, t.hh, t.min, 0, 0);
  const end = new Date(start.getTime() + 2*60*60*1000); // default 2 jam

  const fmt = (dt)=>{
    const pad=(n)=>String(n).padStart(2,'0');
    return dt.getFullYear()+pad(dt.getMonth()+1)+pad(dt.getDate())+"T"+pad(dt.getHours())+pad(dt.getMinutes())+"00";
  };
  const text = encodeURIComponent((d.title||"Walimatul Urus")+" - "+(d.couple||""));
  const details = encodeURIComponent((d.message||"")+"\n\nLokasi: "+(d.venue||"")+" - "+(d.address||""));
  const location = encodeURIComponent((d.venue||"")+" - "+(d.address||""));
  return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&details=${details}&location=${location}&dates=${fmt(start)}/${fmt(end)}`;
}

/* ---------- share ---------- */
async function shareLink(d){
  // share current url (yang ada ?d= kalau dari admin)
  const url = location.href;
  const title = (d.title||"Jemputan")+" - "+(d.couple||"");
  try{
    if(navigator.share){
      await navigator.share({title, text:title, url});
    }else{
      await navigator.clipboard.writeText(url);
      alert("Link disalin.");
    }
  }catch(e){
    try{ await navigator.clipboard.writeText(url); alert("Link disalin."); }catch(_){ alert(url); }
  }
}

/* ---------- video autoplay fix ---------- */
async function initVideo(d){
  const v = $("bgVideo");
  const layer = $("tapToPlay");
  const btn = $("tapBtn");
  if(!d.videoOn){ layer.style.display="none"; return; }

  async function tryPlay(){
    try{
      v.muted = true;
      await v.play();
      layer.style.display="none";
      return true;
    }catch(e){
      layer.style.display="flex";
      return false;
    }
  }
  window.addEventListener("load", ()=>{ tryPlay(); });
  btn.addEventListener("click", async ()=>{ const ok = await tryPlay(); if(!ok) alert("Browser masih sekat autoplay. Cuba refresh dan ketik sekali lagi."); });
  document.addEventListener("visibilitychange", async ()=>{
    if(document.hidden){ try{v.pause();}catch(e){} }
    else { try{await v.play();}catch(e){} }
  });
}

/* ---------- boot ---------- */
(function boot(){
  const d = getData();

  // kalau tiada ?d= dan tiada localStorage, warn (supaya tak ‚Äúhilang-hilang‚Äù)
  const url = new URL(location.href);
  const hasD = !!url.searchParams.get("d");
  const hasLocal = !!localStorage.getItem(STORE_KEY);
  if(!hasD && !hasLocal){
    showWarn("‚ö†Ô∏è Link ini dibuka tanpa data. Untuk tetamu, gunakan link Generate (ada ?d=).");
  }

  applyData(d);
  initVideo(d);

  // gate
  const canOpen = vipAndExpiredCheck(d);
  if(canOpen) startCountdown(d);
})();
</script>
</body>
</html>
