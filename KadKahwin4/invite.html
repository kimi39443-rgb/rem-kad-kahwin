<!doctype html>
<html lang="ms">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Jemputan Perkahwinan</title>

<style>
:root{
  --bg:#050505;
  --txt:#f5f7fb;
  --muted:rgba(245,247,251,.75);
  --line:rgba(255,255,255,.14);
  --shadow:0 25px 70px rgba(0,0,0,.6);
  --a1:#d6b46c; --a2:#f3e2b8; --a3:#b7c6ff;
  --bg1:radial-gradient(900px 600px at 20% 0%, rgba(214,180,108,.20), transparent 55%);
  --bg2:linear-gradient(to bottom, rgba(0,0,0,.25), rgba(0,0,0,.9));
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;height:100%}
body{
  font-family: ui-serif, Georgia, "Times New Roman", serif;
  background:var(--bg);
  color:var(--txt);
  overflow-x:hidden;
}
.overlay{
  position:fixed; inset:0; z-index:-5;
  background:var(--bg1),var(--bg2);
}
.anim{
  position:fixed; inset:0; z-index:-5;
  display:none;
  background:
    radial-gradient(800px 600px at 10% 10%, rgba(214,180,108,.18), transparent 55%),
    radial-gradient(800px 600px at 90% 20%, rgba(183,198,255,.16), transparent 55%);
  animation:float 10s ease-in-out infinite;
}
@keyframes float{50%{transform:translateY(-10px)}}

.tap{
  position:fixed; inset:0; z-index:50;
  display:flex; align-items:center; justify-content:center;
  background:#000; color:#fff;
}
.tap .box{
  width:min(460px,92vw);
  padding:18px;
  border-radius:22px;
  background:rgba(0,0,0,.6);
  border:1px solid rgba(255,255,255,.15);
  box-shadow:var(--shadow);
  text-align:center;
}
.tap button{
  width:100%;
  margin-top:12px;
  padding:12px;
  border-radius:16px;
  border:0;
  font-weight:900;
  background:linear-gradient(135deg,var(--a1),var(--a2));
  color:#111;
}

.door{
  position:fixed; top:0; width:50%; height:100%;
  background:#000; z-index:40;
  transition:transform 1.5s ease;
}
.door.left{left:0}
.door.right{right:0}
body.open .door.left{transform:translateX(-105%)}
body.open .door.right{transform:translateX(105%)}
body.open .tap{display:none}

.wrap{max-width:860px;margin:auto;padding:16px 14px 210px}
.topbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center}
.pill{
  padding:10px 14px;
  border-radius:999px;
  border:1px solid var(--line);
  background:rgba(0,0,0,.25);
  font-size:12px;
  display:flex; gap:8px; align-items:center;
}
.pill button, .pill select{
  background:none;border:0;color:var(--txt);font-weight:900;cursor:pointer
}
.pill select{outline:none}

.card{
  margin-top:14px;
  border-radius:26px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.06);
  box-shadow:var(--shadow);
  overflow:hidden;
}
.hero{text-align:center;padding:22px}
.badge{letter-spacing:3px;font-size:12px;opacity:.85}
h1{
  font-size:34px;margin:14px 0 6px;
  background:linear-gradient(135deg,var(--a1),var(--a2));
  -webkit-background-clip:text;color:transparent;
  user-select:none;
}
.names{font-size:20px;line-height:1.35}
.divider{
  width:70px;height:2px;margin:16px auto;
  background:linear-gradient(to right,var(--a1),var(--a2),var(--a3));
}
.grid{padding:16px;display:grid;gap:10px}
.item{padding:12px;border-radius:16px;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.10)}
.actions{padding:16px;display:grid;gap:10px}
.btn{
  padding:14px;border-radius:18px;border:0;
  font-weight:900;cursor:pointer
}
.primary{background:linear-gradient(135deg,var(--a1),var(--a2));color:#111}
.small{font-size:12px;color:var(--muted);margin-top:8px;text-align:center}

.editor{
  position:fixed; inset:0; z-index:60;
  background:rgba(0,0,0,.75);
  display:none; overflow:auto;
  padding:16px;
}
.editor .panel{
  max-width:860px;margin:10px auto;padding:16px;
  border-radius:22px;
  background:rgba(15,18,26,.92);
  border:1px solid rgba(255,255,255,.14);
}
.editor h3{margin:6px 0 10px}
.editor label{display:block;margin:10px 0 6px;color:rgba(255,255,255,.78);font-size:12px}
.editor input, .editor textarea, .editor select{
  width:100%;padding:11px;border-radius:14px;
  background:rgba(0,0,0,.35);color:#fff;border:1px solid rgba(255,255,255,.14);
  outline:none;
}
.editor textarea{min-height:72px;resize:vertical}
.editor .row{display:grid;grid-template-columns:1fr;gap:10px}
@media(min-width:720px){.editor .row.two{grid-template-columns:1fr 1fr}}
.editor .bar{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:12px}
@media(max-width:520px){.editor .bar{grid-template-columns:1fr}}
.editor button{padding:12px;border-radius:14px;border:0;font-weight:900;cursor:pointer}
.editor .save{background:linear-gradient(135deg,var(--a1),var(--a2));color:#111}
.editor .close,.editor .reset{background:rgba(255,255,255,.10);color:#fff;border:1px solid rgba(255,255,255,.14)}
.warn{margin-top:10px;color:#ffd3d3;font-size:12px;line-height:1.45}
.ok{margin-top:10px;color:#c6ffd8;font-size:12px;line-height:1.45}

#ytWrap{position:fixed;left:-9999px;top:-9999px;width:1px;height:1px;overflow:hidden}

/* Bottom actions */
.bottomBar{
  position:fixed; left:0; right:0; bottom:0; z-index:55;
  padding:10px 12px;
  background:rgba(0,0,0,.55);
  border-top:1px solid rgba(255,255,255,.14);
  backdrop-filter: blur(10px);
}
.bottomRow{
  max-width:860px;margin:0 auto;
  display:grid; grid-template-columns:1fr 1fr; gap:10px;
}
.bbtn{
  border:0; border-radius:18px; padding:14px 12px;
  font-weight:900; cursor:pointer;
  color:#111;
  background:linear-gradient(135deg,var(--a1),var(--a2));
}
.bbtn.secondary{
  color:#fff;
  background:rgba(255,255,255,.12);
  border:1px solid rgba(255,255,255,.18);
}

/* Watermark */
.watermark{
  position:fixed; left:0; right:0; bottom:64px;
  z-index:52;
  text-align:center;
  font-size:12px;
  letter-spacing:.4px;
  opacity:.55;
  pointer-events:none;
  display:none;
}

/* Expired overlay */
.expired{
  position:fixed; inset:0; z-index:70;
  display:none;
  background:rgba(0,0,0,.85);
  color:#fff;
}
.expired .box{
  width:min(460px,92vw);
  margin:18vh auto 0;
  padding:18px;
  border-radius:22px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(0,0,0,.55);
  box-shadow:var(--shadow);
  text-align:center;
}
.expired .box h3{margin:8px 0 6px}
.expired .box p{opacity:.85; line-height:1.5}

/* Production block (htmlpreview) */
.blocker{
  position:fixed; inset:0; z-index:9999;
  display:none;
  background:rgba(0,0,0,.92);
  color:#fff;
}
.blocker .box{
  width:min(520px,92vw);
  margin:14vh auto 0;
  padding:18px;
  border-radius:22px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(0,0,0,.55);
  box-shadow:var(--shadow);
}
.blocker h3{margin:8px 0 6px}
.blocker p{opacity:.9; line-height:1.5}
.blocker code{
  display:block;
  margin-top:10px;
  padding:10px;
  border-radius:14px;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.16);
  word-break:break-all;
  font-size:12px;
}
</style>
</head>

<body>
<div class="overlay"></div>
<div class="anim" id="animLayer"></div>

<div class="tap" id="tapLayer">
  <div class="box">
    <h3>JEMPUTAN PERKAHWINAN</h3>
    <p>Tekan untuk buka kad</p>
    <button type="button" onclick="openInvite()">BUKA KAD</button>
  </div>
</div>

<div class="door left"></div>
<div class="door right"></div>

<audio id="bgm" loop></audio>
<div id="ytWrap"><div id="ytPlayer"></div></div>

<div class="wrap">
  <div class="topbar">
    <div class="pill">üé®
      <select id="presetSelect">
        <option value="gold">Gold Luxury</option>
        <option value="floral">Floral White</option>
        <option value="royal">Royal Night</option>
      </select>
    </div>

    <div class="pill"><button id="playBtn" type="button">‚ñ∂Ô∏è PLAY</button></div>
    <div class="pill"><button id="stopBtn" type="button">‚èπÔ∏è STOP</button></div>
    <div class="pill"><button id="muteBtn" type="button">MUTE</button></div>

    <!-- admin-only (auto hide bila customerMode ON) -->
    <div class="pill" id="editPill"><button id="editBtn" type="button">EDIT</button></div>
  </div>

  <div class="card">
    <div class="hero">
      <div class="badge" id="badge">WALIMATULURUS</div>
      <!-- Secret tap target -->
      <h1 id="titleTap">Jemputan Perkahwinan</h1>

      <div class="names">
        <div id="groom">Nama Pengantin Lelaki</div>
        <div style="opacity:.85;margin:6px 0">‚ô•</div>
        <div id="bride">Nama Pengantin Perempuan</div>
      </div>

      <div class="divider"></div>
      <div id="inviteText">Dengan penuh kesyukuran, kami menjemput anda hadir.</div>
      <div class="small" id="musicInfo">Muzik: Preset</div>
      <div class="small" id="musicHint">Jika tiada bunyi, tekan ‚ñ∂Ô∏è PLAY.</div>
      <!-- ‚úÖ link panjang sudah dibuang dari paparan pelanggan -->
    </div>

    <div class="grid">
      <div class="item" id="dateText">üìÖ 31/12/2025</div>
      <div class="item" id="timeText">‚è∞ 9:00 AM ‚Äì 2:00 PM</div>
      <div class="item" id="venueText">üìç Dewan Contoh, Pulau Pinang</div>
    </div>

    <div class="actions">
      <button class="btn primary" id="btnRsvp" type="button">üí¨ RSVP WhatsApp</button>
      <button class="btn" id="btnMaps" type="button">üìç Google Maps</button>
    </div>
  </div>
</div>

<div class="watermark" id="wm"></div>

<div class="bottomBar" id="bottomBar">
  <div class="bottomRow">
    <button class="bbtn" id="shareBtn" type="button">üì§ SHARE INVITE</button>
    <button class="bbtn secondary" id="copyBtn" type="button">üìã COPY LINK</button>
  </div>

  <!-- admin-only row (auto hide bila customerMode ON) -->
  <div class="bottomRow" id="adminRow" style="margin-top:10px;">
    <button class="bbtn secondary" id="newLinkBtn" type="button">‚ú® GENERATE NEW LINK</button>
    <button class="bbtn secondary" id="adminBtn" type="button">üîê ADMIN</button>
  </div>
</div>

<div class="expired" id="expiredLayer">
  <div class="box">
    <h3>‚õî Link Telah Tamat</h3>
    <p id="expiredMsg">Sila hubungi pihak admin untuk link terbaru.</p>
    <button class="bbtn" type="button" onclick="closeExpired()">OK</button>
  </div>
</div>

<!-- Production block -->
<div class="blocker" id="blocker">
  <div class="box">
    <h3>‚õî Mode Preview Tidak Disokong</h3>
    <p>
      Template ini adalah <b>Production</b>. Sila buka menggunakan <b>GitHub Pages</b> (domain kimi39443-rgb.github.io).
      Mode htmlpreview biasanya menyekat fungsi Share/Copy.
    </p>
    <p style="margin-top:10px;">Gunakan URL seperti ini:</p>
    <code id="prodUrl"></code>
    <button class="bbtn" type="button" style="margin-top:12px;" onclick="tryCopyProd()">üìã COPY URL PRODUCTION</button>
  </div>
</div>

<!-- EDITOR -->
<div class="editor" id="editor">
  <div class="panel">
    <h3>Edit Kad (Production Premium)</h3>

    <div class="row two">
      <div>
        <label>Pakej Pelanggan</label>
        <select id="fPackage">
          <option value="gold">Gold</option>
          <option value="platinum">Platinum</option>
          <option value="vip">VIP</option>
        </select>
      </div>
      <div>
        <label>Preset Tema</label>
        <select id="fPreset">
          <option value="gold">Gold Luxury</option>
          <option value="floral">Floral White</option>
          <option value="royal">Royal Night</option>
        </select>
      </div>
    </div>

    <div class="row two">
      <div>
        <label>Animasi glow</label>
        <select id="fAnim">
          <option value="1">ON</option>
          <option value="0">OFF</option>
        </select>
      </div>
      <div>
        <label>Mode Pelanggan (sorok semua butang admin)</label>
        <select id="fCustomerMode">
          <option value="0">OFF (admin nampak butang)</option>
          <option value="1">ON (pelanggan tak nampak)</option>
        </select>
      </div>
    </div>

    <div class="row two">
      <div>
        <label>Nama Pengantin Lelaki</label>
        <input id="fGroom" placeholder="Contoh: Ahmad">
      </div>
      <div>
        <label>Nama Pengantin Perempuan</label>
        <input id="fBride" placeholder="Contoh: Siti">
      </div>
    </div>

    <label>Ayat Jemputan</label>
    <textarea id="fInvite" placeholder="Dengan penuh kesyukuran..."></textarea>

    <div class="row two">
      <div>
        <label>Tarikh (paparan)</label>
        <input id="fDateText" placeholder="31/12/2025">
      </div>
      <div>
        <label>Masa (paparan 12 jam)</label>
        <input id="fTimeText" placeholder="9:00 AM ‚Äì 2:00 PM">
      </div>
    </div>

    <label>Lokasi (paparan)</label>
    <textarea id="fVenueText" placeholder="Dewan..."></textarea>

    <div class="row two">
      <div>
        <label>No WhatsApp (cth 60123456789)</label>
        <input id="fPhone" placeholder="6012xxxxxxx">
      </div>
      <div>
        <label>Teks RSVP</label>
        <input id="fRsvpText" placeholder="Hi, saya ingin RSVP hadir...">
      </div>
    </div>

    <div class="row two">
      <div>
        <label>Maps Link (optional)</label>
        <input id="fMapsLink" placeholder="https://maps.app.goo.gl/...">
      </div>
      <div>
        <label>Maps Search (jika tiada link)</label>
        <input id="fMapsQuery" placeholder="Nama dewan / alamat">
      </div>
    </div>

    <div class="row two">
      <div>
        <label>üéµ MP3 URL (paling stabil)</label>
        <input id="fMp3" placeholder="https://.../lagu.mp3">
      </div>
      <div>
        <label>‚ñ∂Ô∏è YouTube URL (bukan YouTube Music)</label>
        <input id="fYt" placeholder="https://youtu.be/VIDEO_ID atau https://youtube.com/watch?v=VIDEO_ID">
      </div>
    </div>

    <div class="warn">
      ‚ö†Ô∏è YouTube Music (music.youtube.com) memang tak boleh bunyi. Guna YouTube biasa sahaja.
    </div>

    <div class="row two">
      <div>
        <label>Expired (ON/OFF)</label>
        <select id="fExpOn">
          <option value="0">OFF</option>
          <option value="1">ON</option>
        </select>
      </div>
      <div>
        <label>Tarikh Expired (DD/MM/YYYY)</label>
        <input id="fExpDate" placeholder="31/12/2025">
      </div>
    </div>

    <div class="row two">
      <div>
        <label>Masa Expired (12 jam, contoh 9:30 PM)</label>
        <input id="fExpTime" placeholder="9:30 PM">
      </div>
      <div>
        <label>Mesej Expired</label>
        <input id="fExpMsg" placeholder="Sila hubungi admin untuk link terbaru.">
      </div>
    </div>

    <div class="row two">
      <div>
        <label>Watermark (ON/OFF)</label>
        <select id="fWmOn">
          <option value="0">OFF</option>
          <option value="1">ON</option>
        </select>
      </div>
      <div>
        <label>Teks Watermark</label>
        <input id="fWmText" placeholder="Contoh: Powered by NamaBrand">
      </div>
    </div>

    <div class="row two">
      <div>
        <label>Admin PIN (untuk buka EDIT)</label>
        <input id="fPin" placeholder="Contoh: 1234">
      </div>
      <div>
        <label>Auto Logout (minit)</label>
        <select id="fAutoLogout">
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="15" selected>15</option>
          <option value="30">30</option>
        </select>
      </div>
    </div>

    <div class="ok" id="adminLinkBox" style="display:none;">
      <div style="font-weight:900;margin-bottom:6px;">üîó Link (Admin sahaja)</div>
      <div id="adminLinkText" style="word-break:break-all;font-size:12px;opacity:.9;"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
        <button class="bbtn secondary" type="button" onclick="copyAdminLink()">üìã COPY LINK</button>
        <button class="bbtn" type="button" onclick="shareAdminLink()">üì§ SHARE</button>
      </div>
    </div>

    <div class="bar">
      <button class="close" type="button" onclick="closeEditor()">Tutup</button>
      <button class="reset" type="button" onclick="resetAll()">Reset</button>
      <button class="save" type="button" onclick="saveEditor()">Simpan</button>
    </div>

    <div class="ok" id="saveMsg" style="display:none;">
      ‚úÖ Disimpan. Link admin ada dalam panel (Admin sahaja).
      <br>Tip: Jika customer mode ON, untuk masuk admin guna <b>tap 7x pada tajuk ‚ÄúJemputan Perkahwinan‚Äù</b>.
    </div>
  </div>
</div>

<!-- Toast tip -->
<div id="toastHint" style="
  position:fixed; left:50%; bottom:150px; transform:translateX(-50%);
  z-index:9999;
  width:min(520px, 92vw);
  display:none;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(0,0,0,.72);
  backdrop-filter: blur(10px);
  box-shadow: 0 20px 60px rgba(0,0,0,.55);
  padding:12px 12px;
  color:#fff;
">
  <div style="display:flex; gap:10px; align-items:flex-start;">
    <div style="font-size:18px; line-height:1;">üîä</div>
    <div style="flex:1;">
      <div style="font-weight:900;">Tip Bunyi</div>
      <div style="font-size:12px; opacity:.85; margin-top:4px; line-height:1.4;">
        Jika tiada bunyi, tekan <b>‚ñ∂Ô∏è PLAY</b>.
      </div>
    </div>
    <button id="toastOk" type="button" style="
      border:0; cursor:pointer;
      border-radius:12px;
      padding:8px 10px;
      font-weight:900;
      background:rgba(255,255,255,.14);
      color:#fff;
    ">OK</button>
  </div>
</div>

<script>
/* =========================
   STORAGE KEYS
========================= */
const STORAGE_KEY = "KK_PRO_PREMIUM_V4";
const AUTH_KEY = "KK_ADMIN_AUTH_V4";
const PIN_KEY  = "KK_ADMIN_PIN_V4";
const TOAST_KEY = "KK_TOAST_MUSIC_HINT_SHOWN_V4";

/* =========================
   PRESETS
========================= */
const PRESETS = {
  gold:{
    label:"Gold Luxury",
    a1:"#d6b46c", a2:"#f3e2b8", a3:"#b7c6ff",
    bg:"#050505",
    bg1:"radial-gradient(900px 600px at 20% 0%, rgba(214,180,108,.20), transparent 55%)",
    bg2:"linear-gradient(to bottom, rgba(0,0,0,.25), rgba(0,0,0,.9))",
    presetMp3:"https://raw.githubusercontent.com/kimi39443-rgb/rem-kad-kahwin/main/KadKahwin4/assets/gold.mp3"
  },
  floral:{
    label:"Floral White",
    a1:"#111827", a2:"#c7ccd8", a3:"#8fb3ff",
    bg:"#f6f7fb",
    bg1:"radial-gradient(1200px 700px at 15% 0%, rgba(143,179,255,.20), transparent 55%)",
    bg2:"linear-gradient(to bottom, rgba(255,255,255,.70), rgba(246,247,251,.88))",
    presetMp3:"https://raw.githubusercontent.com/kimi39443-rgb/rem-kad-kahwin/main/KadKahwin4/assets/floral.mp3"
  },
  royal:{
    label:"Royal Night",
    a1:"#60a5fa", a2:"#c7d2fe", a3:"#fca5a5",
    bg:"#030712",
    bg1:"radial-gradient(1000px 650px at 18% 0%, rgba(96,165,250,.22), transparent 55%)",
    bg2:"linear-gradient(to bottom, rgba(0,0,0,.20), rgba(0,0,0,.92))",
    presetMp3:"https://raw.githubusercontent.com/kimi39443-rgb/rem-kad-kahwin/main/KadKahwin4/assets/royal.mp3"
  }
};

/* =========================
   PACKAGE DEFAULTS (Gold/Platinum/VIP)
   - boleh ubah ikut citarasa
========================= */
const PACKAGE_DEFAULTS = {
  gold: {
    preset: "gold",
    wmOn: 1,
    wmText: "Powered by KadKahwin Gold",
    animOn: 1
  },
  platinum: {
    preset: "royal",
    wmOn: 1,
    wmText: "Powered by KadKahwin Platinum",
    animOn: 1
  },
  vip: {
    preset: "floral",
    wmOn: 0,
    wmText: "",
    animOn: 1
  }
};

const DEFAULTS = {
  ver: 4,

  package: "gold",
  preset:"gold",
  animOn:1,
  customerMode: 1,   // ‚úÖ default: pelanggan tak nampak admin button

  groom:"Nama Pengantin Lelaki",
  bride:"Nama Pengantin Perempuan",
  inviteText:"Dengan penuh kesyukuran, kami menjemput anda hadir.",

  dateText:"31/12/2025",
  timeText:"9:00 AM ‚Äì 2:00 PM",
  venueText:"Dewan Contoh, Pulau Pinang",

  rsvpPhone:"60123456789",
  rsvpText:"Hi, saya ingin RSVP hadir ke majlis perkahwinan.",

  mapsLink:"",
  mapsQuery:"Dewan Contoh, Pulau Pinang",

  // Muzik
  mp3Url:"",
  ytUrl:"",

  // Expired
  expOn:0,
  expDate:"31/12/2025",
  expTime:"9:00 PM",
  expMsg:"Sila hubungi admin untuk link terbaru.",

  // Admin
  autoLogoutMin:15,
  adminPin:"1234",

  // Watermark
  wmOn: 1,
  wmText: "Powered by KadKahwin Premium"
};

let state = loadMergedState();
let isMuted = false;

/* YouTube */
let ytReady = false;
let ytPlayer = null;

/* Secret admin tap */
let tapCount = 0;
let tapTimer = null;

/* =========================
   HELPERS
========================= */
function $(id){ return document.getElementById(id); }
function safeJSONParse(s){ try{ return JSON.parse(s); }catch(e){ return null; } }

function persist(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  localStorage.setItem(PIN_KEY, state.adminPin || "1234");
}

function b64urlEncode(str){
  const b64 = btoa(unescape(encodeURIComponent(str)));
  return b64.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function b64urlDecode(b64url){
  const b64 = b64url.replace(/-/g,'+').replace(/_/g,'/');
  const pad = b64.length % 4 ? '='.repeat(4 - (b64.length % 4)) : '';
  const s = atob(b64 + pad);
  return decodeURIComponent(escape(s));
}

/* Load State: URL ?d= > localStorage > defaults */
function loadMergedState(){
  const url = new URL(location.href);
  const d = url.searchParams.get("d");
  let fromUrl = null;

  if(d){
    try{
      const json = b64urlDecode(d);
      fromUrl = safeJSONParse(json);
    }catch(e){ fromUrl = null; }
  }

  const raw = localStorage.getItem(STORAGE_KEY);
  const fromLs = raw ? safeJSONParse(raw) : null;

  const merged = {...DEFAULTS, ...(fromLs||{}), ...(fromUrl||{})};

  // ensure package exists
  if(!merged.package || !PACKAGE_DEFAULTS[merged.package]) merged.package = "gold";
  return merged;
}

function getBaseUrl(){
  const u = new URL(location.href);
  u.search = "";
  u.hash = "";
  return u.toString();
}

function buildInviteLink(){
  const base = getBaseUrl();
  const clean = {...state};
  const json = JSON.stringify(clean);
  return base + "?d=" + b64urlEncode(json);
}

/* Copy / Share */
async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  }catch(e){
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position="fixed"; ta.style.left="-9999px";
    document.body.appendChild(ta);
    ta.focus(); ta.select();
    let ok=false;
    try{ ok=document.execCommand("copy"); }catch(err){ ok=false; }
    document.body.removeChild(ta);
    return ok;
  }
}

/* =========================
   PRODUCTION BLOCK (htmlpreview)
========================= */
function isHtmlPreview(){
  return location.hostname.includes("htmlpreview.github.io") || location.href.includes("htmlpreview.github.io/?");
}
function showBlocker(){
  const real = "https://kimi39443-rgb.github.io/rem-kad-kahwin/KadKahwin4/invite.html";
  $("prodUrl").textContent = real;
  $("blocker").style.display = "block";

  // disable buttons (safety)
  $("shareBtn").disabled = true;
  $("copyBtn").disabled = true;
  $("newLinkBtn").disabled = true;
  $("adminBtn").disabled = true;
  $("editBtn").disabled = true;
}
async function tryCopyProd(){
  const real = $("prodUrl").textContent;
  const ok = await copyText(real);
  alert(ok ? "‚úÖ URL Production telah disalin" : "‚ùå Tak dapat copy. Copy manual dari kotak.");
}
window.tryCopyProd = tryCopyProd;

/* =========================
   APPLY PRESET / PACKAGE
========================= */
function applyPresetUI(key){
  const p = PRESETS[key] || PRESETS.gold;
  const root = document.documentElement.style;
  root.setProperty("--a1", p.a1);
  root.setProperty("--a2", p.a2);
  root.setProperty("--a3", p.a3);
  root.setProperty("--bg", p.bg);
  root.setProperty("--bg1", p.bg1);
  root.setProperty("--bg2", p.bg2);

  $("animLayer").style.display = (Number(state.animOn)===1) ? "block" : "none";
}

function applyPackageDefaults(pkg, soft=true){
  const d = PACKAGE_DEFAULTS[pkg] || PACKAGE_DEFAULTS.gold;

  // soft=true: hanya apply bila field kosong / default
  if(!soft){
    state.preset = d.preset;
    state.wmOn = d.wmOn;
    state.wmText = d.wmText;
    state.animOn = d.animOn;
    return;
  }

  // soft apply
  if(!state.preset) state.preset = d.preset;
  // kalau user belum customize watermark
  if(state.wmText === DEFAULTS.wmText) {
    state.wmOn = d.wmOn;
    state.wmText = d.wmText;
  }
}

/* =========================
   WA / MAPS
========================= */
function buildWhatsApp(){
  const text = encodeURIComponent((state.rsvpText||"") + ` ( ${state.groom} & ${state.bride} )`);
  return `https://wa.me/${state.rsvpPhone}?text=${text}`;
}
function buildMaps(){
  if(state.mapsLink && state.mapsLink.trim()) return state.mapsLink.trim();
  return "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(state.mapsQuery || state.venueText);
}

/* =========================
   MUSIC
========================= */
function stopAllAudio(){
  const a = $("bgm");
  try{ a.pause(); a.currentTime = 0; }catch(e){}
  if(ytPlayer && ytReady){
    try{ ytPlayer.stopVideo(); }catch(e){}
  }
}
function isYouTubeMusic(url){
  return (url||"").includes("music.youtube.com");
}
function parseYouTubeId(url){
  if(!url) return "";
  const s = String(url).trim();
  if(!s) return "";
  if(/^[a-zA-Z0-9_-]{11}$/.test(s)) return s;
  try{
    const u = new URL(s);
    if(u.hostname.includes("youtu.be")) return u.pathname.replace("/","");
    if(u.searchParams.get("v")) return u.searchParams.get("v");
    const m = u.pathname.match(/\/shorts\/([a-zA-Z0-9_-]{11})/);
    if(m) return m[1];
  }catch(e){}
  return "";
}
function setMp3Source(url){
  $("bgm").src = url ? url.trim() : "";
}
function ensureYouTubeApi(cb){
  if(window.YT && window.YT.Player){ ytReady = true; cb(); return; }
  if(document.getElementById("ytApiScript")){
    const t = setInterval(()=>{
      if(window.YT && window.YT.Player){
        clearInterval(t);
        ytReady = true;
        cb();
      }
    },200);
    return;
  }
  const s = document.createElement("script");
  s.id="ytApiScript";
  s.src="https://www.youtube.com/iframe_api";
  document.head.appendChild(s);
  window.onYouTubeIframeAPIReady = () => { ytReady=true; cb(); };
}
function loadOrPlayYouTube(videoId){
  if(!videoId) return;
  if(!ytPlayer){
    ytPlayer = new YT.Player("ytPlayer",{
      height:"0", width:"0", videoId,
      playerVars:{ autoplay:0, controls:0, rel:0, modestbranding:1, playsinline:1 },
      events:{
        onReady:()=>{
          try{
            ytPlayer.setVolume(isMuted ? 0 : 100);
            ytPlayer.playVideo();
          }catch(e){}
        }
      }
    });
  }else{
    try{
      ytPlayer.loadVideoById(videoId);
      ytPlayer.setVolume(isMuted ? 0 : 100);
      ytPlayer.playVideo();
    }catch(e){}
  }
}
function chooseMusicMode(){
  const p = PRESETS[state.preset] || PRESETS.gold;

  if(state.mp3Url && state.mp3Url.trim()){
    $("musicInfo").textContent = "Muzik: MP3 Custom ‚úÖ";
    return { type:"mp3", src: state.mp3Url.trim() };
  }

  if(state.ytUrl && state.ytUrl.trim()){
    const url = state.ytUrl.trim();
    if(isYouTubeMusic(url)){
      $("musicInfo").textContent = "Muzik: YouTube Music ‚ùå ‚Äî guna YouTube biasa";
      return { type:"none", src:"" };
    }
    const id = parseYouTubeId(url);
    if(id){
      $("musicInfo").textContent = "Muzik: YouTube Custom ‚úÖ";
      return { type:"yt", src:id };
    }
    $("musicInfo").textContent = "Muzik: YouTube ‚ùå (link tak sah)";
    return { type:"none", src:"" };
  }

  $("musicInfo").textContent = "Muzik: Preset ‚úÖ (" + p.label + ")";
  return { type:"mp3", src: p.presetMp3 };
}
function playMusicManual(){
  stopAllAudio();
  const mode = chooseMusicMode();

  if(mode.type === "mp3" && mode.src){
    setMp3Source(mode.src);
    const a = $("bgm");
    a.muted = isMuted;
    a.play().catch(()=>alert("Tak dapat main MP3. Pastikan link direct .mp3 & volume media naik."));
    return;
  }
  if(mode.type === "yt" && mode.src){
    ensureYouTubeApi(()=>loadOrPlayYouTube(mode.src));
    return;
  }
  alert("Tiada muzik boleh dimainkan. Isi MP3 URL atau YouTube URL (bukan YouTube Music).");
}
function toggleMute(){
  isMuted = !isMuted;
  $("bgm").muted = isMuted;
  if(ytPlayer && ytReady){
    try{ ytPlayer.setVolume(isMuted ? 0 : 100); }catch(e){}
  }
}

/* =========================
   TOAST TIP
========================= */
function showToastHintOnce(){
  try{ if(localStorage.getItem(TOAST_KEY) === "1") return; }catch(e){}
  const t = $("toastHint"), ok = $("toastOk");
  if(!t || !ok) return;
  t.style.display="block";
  const hide=()=>{
    t.style.display="none";
    try{ localStorage.setItem(TOAST_KEY,"1"); }catch(e){}
  };
  ok.onclick=hide;
  setTimeout(hide, 5000);
}

/* =========================
   EXPIRED
========================= */
function parseDDMMYYYY(s){
  const m = String(s||"").trim().match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(!m) return null;
  const dd = Number(m[1]), mm = Number(m[2]), yy = Number(m[3]);
  if(mm<1||mm>12||dd<1||dd>31) return null;
  return {dd,mm,yy};
}
function parseTime12h(s){
  const m = String(s||"").trim().match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
  if(!m) return null;
  let hh = Number(m[1]), min = Number(m[2]);
  const ap = m[3].toUpperCase();
  if(hh<1||hh>12||min<0||min>59) return null;
  if(ap==="AM"){ if(hh===12) hh=0; }
  else { if(hh!==12) hh+=12; }
  return {hh,min};
}
function getExpiryMs(){
  if(Number(state.expOn)!==1) return null;
  const d = parseDDMMYYYY(state.expDate);
  const t = parseTime12h(state.expTime);
  if(!d || !t) return null;
  return new Date(d.yy, d.mm-1, d.dd, t.hh, t.min, 0, 0).getTime();
}
function checkExpired(){
  const ms = getExpiryMs();
  if(!ms) return false;
  return Date.now() > ms;
}
function showExpired(){
  $("expiredMsg").textContent = state.expMsg || "Sila hubungi admin untuk link terbaru.";
  $("expiredLayer").style.display="block";
  $("tapLayer").style.display="none";
}
function closeExpired(){ $("expiredLayer").style.display="none"; }
window.closeExpired = closeExpired;

/* =========================
   ADMIN PIN + AUTO LOGOUT
========================= */
function getSavedPin(){ return localStorage.getItem(PIN_KEY) || state.adminPin || "1234"; }
function setAuthNow(){ localStorage.setItem(AUTH_KEY, String(Date.now())); }
function isAuthed(){
  const last = Number(localStorage.getItem(AUTH_KEY) || 0);
  if(!last) return false;
  const mins = Number(state.autoLogoutMin || 15);
  return (Date.now() - last) <= mins*60*1000;
}
function requirePin(){
  if(isAuthed()) { setAuthNow(); return true; }
  const pin = prompt("Masukkan Admin PIN:");
  if(pin === null) return false;
  if(pin.trim() === getSavedPin()){
    setAuthNow();
    return true;
  }
  alert("PIN salah.");
  return false;
}

/* =========================
   CUSTOMER MODE + WATERMARK + ADMIN VISIBILITY
========================= */
function applyCustomerMode(){
  const on = Number(state.customerMode) === 1;
  $("editPill").style.display = on ? "none" : "flex";
  $("adminRow").style.display = on ? "none" : "grid";
}
function applyWatermark(){
  const on = Number(state.wmOn) === 1;
  const wm = $("wm");
  wm.textContent = state.wmText || "";
  wm.style.display = (on && wm.textContent.trim()) ? "block" : "none";
}

/* =========================
   RENDER
========================= */
function render(){
  applyPackageDefaults(state.package, true);
  applyPresetUI(state.preset);
  $("presetSelect").value = state.preset;

  $("groom").textContent = state.groom;
  $("bride").textContent = state.bride;
  $("inviteText").textContent = state.inviteText;

  $("dateText").textContent = "üìÖ " + state.dateText;
  $("timeText").textContent = "‚è∞ " + state.timeText;
  $("venueText").textContent = "üìç " + state.venueText;

  $("btnRsvp").onclick = ()=>window.open(buildWhatsApp(), "_blank");
  $("btnMaps").onclick = ()=>window.open(buildMaps(), "_blank");

  chooseMusicMode();
  applyCustomerMode();
  applyWatermark();
}

/* =========================
   EDITOR
========================= */
function openEditor(){
  if(!requirePin()) return;
  $("editor").style.display="block";
  $("saveMsg").style.display="none";

  $("fPackage").value = state.package;
  $("fPreset").value = state.preset;
  $("fAnim").value = String(state.animOn);
  $("fCustomerMode").value = String(state.customerMode);

  $("fGroom").value = state.groom;
  $("fBride").value = state.bride;
  $("fInvite").value = state.inviteText;

  $("fDateText").value = state.dateText;
  $("fTimeText").value = state.timeText;
  $("fVenueText").value = state.venueText;

  $("fPhone").value = state.rsvpPhone;
  $("fRsvpText").value = state.rsvpText;

  $("fMapsLink").value = state.mapsLink;
  $("fMapsQuery").value = state.mapsQuery;

  $("fMp3").value = state.mp3Url;
  $("fYt").value = state.ytUrl;

  $("fExpOn").value = String(state.expOn);
  $("fExpDate").value = state.expDate;
  $("fExpTime").value = state.expTime;
  $("fExpMsg").value = state.expMsg;

  $("fWmOn").value = String(state.wmOn);
  $("fWmText").value = state.wmText;

  $("fPin").value = getSavedPin();
  $("fAutoLogout").value = String(state.autoLogoutMin || 15);

  // show admin-only link box
  $("adminLinkBox").style.display = "block";
  $("adminLinkText").textContent = buildInviteLink();
}
function closeEditor(){ $("editor").style.display="none"; }
window.openEditor = openEditor;
window.closeEditor = closeEditor;

function saveEditor(){
  state.package = $("fPackage").value;
  if(!PACKAGE_DEFAULTS[state.package]) state.package="gold";

  state.preset = $("fPreset").value;
  state.animOn = Number($("fAnim").value);
  state.customerMode = Number($("fCustomerMode").value);

  state.groom = $("fGroom").value.trim() || state.groom;
  state.bride = $("fBride").value.trim() || state.bride;
  state.inviteText = $("fInvite").value.trim() || state.inviteText;

  state.dateText = $("fDateText").value.trim() || state.dateText;
  state.timeText = $("fTimeText").value.trim() || state.timeText;
  state.venueText = $("fVenueText").value.trim() || state.venueText;

  state.rsvpPhone = $("fPhone").value.trim() || state.rsvpPhone;
  state.rsvpText = $("fRsvpText").value.trim() || state.rsvpText;

  state.mapsLink = $("fMapsLink").value.trim();
  state.mapsQuery = $("fMapsQuery").value.trim() || state.mapsQuery;

  // auto elak konflik mp3/yt
  const mp3 = $("fMp3").value.trim();
  const yt  = $("fYt").value.trim();
  if(mp3){ state.mp3Url = mp3; state.ytUrl = ""; }
  else if(yt){ state.ytUrl = yt; state.mp3Url = ""; }
  else { state.mp3Url=""; state.ytUrl=""; }

  state.expOn = Number($("fExpOn").value);
  state.expDate = $("fExpDate").value.trim() || state.expDate;
  state.expTime = $("fExpTime").value.trim() || state.expTime;
  state.expMsg  = $("fExpMsg").value.trim() || state.expMsg;

  state.wmOn = Number($("fWmOn").value);
  state.wmText = ($("fWmText").value || "").trim();

  const pin = ($("fPin").value || "").trim();
  state.adminPin = pin || state.adminPin || "1234";
  state.autoLogoutMin = Number($("fAutoLogout").value || 15);

  persist();
  setAuthNow();
  render();

  $("saveMsg").style.display="block";

  // update url for sharing
  const link = buildInviteLink();
  history.replaceState(null, "", link);

  // update admin-only link display
  $("adminLinkText").textContent = link;
}
window.saveEditor = saveEditor;

function resetAll(){
  if(!confirm("Reset semua data?")) return;
  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem(AUTH_KEY);
  localStorage.removeItem(TOAST_KEY);
  localStorage.removeItem(PIN_KEY);
  stopAllAudio();
  state = {...DEFAULTS};
  applyPackageDefaults(state.package, false);
  persist();
  render();
  closeEditor();
  history.replaceState(null, "", getBaseUrl());
}
window.resetAll = resetAll;

/* =========================
   ADMIN LINK ACTIONS (Editor only)
========================= */
async function copyAdminLink(){
  const link = buildInviteLink();
  const ok = await copyText(link);
  alert(ok ? "‚úÖ Link telah disalin" : "‚ùå Tak dapat copy. Copy manual dari box.");
}
async function shareAdminLink(){
  const link = buildInviteLink();
  if(navigator.share){
    try{
      await navigator.share({ title:"Jemputan Perkahwinan", text:"Jemputan Perkahwinan", url: link });
      return;
    }catch(e){}
  }
  await copyAdminLink();
}
window.copyAdminLink = copyAdminLink;
window.shareAdminLink = shareAdminLink;

/* =========================
   INVITE OPEN
========================= */
function openInvite(){
  if(checkExpired()){ showExpired(); return; }
  document.body.classList.add("open");
  render();
  showToastHintOnce();
}
window.openInvite = openInvite;

/* =========================
   SHARE/COPY/NEWLINK (Bottom bar)
========================= */
async function doCopy(){
  const link = buildInviteLink();
  const ok = await copyText(link);
  alert(ok ? "‚úÖ Link telah disalin" : "‚ùå Tak dapat copy. Sila cuba browser lain.");
}
async function doShare(){
  const link = buildInviteLink();
  if(navigator.share){
    try{
      await navigator.share({ title:"Jemputan Perkahwinan", text:"Jemputan Perkahwinan", url: link });
      return;
    }catch(e){}
  }
  await doCopy();
}
async function generateNewLink(){
  // link unik untuk setiap customer
  state._id = "C" + Date.now().toString(36) + Math.random().toString(36).slice(2,7);
  persist();
  render();
  const link = buildInviteLink();
  history.replaceState(null, "", link);
  await doCopy();
}
function adminQuick(){
  if(!requirePin()) return;
  openEditor();
}

/* =========================
   SECRET ADMIN ENTRY (7 taps on title)
========================= */
function secretTap(){
  tapCount++;
  if(tapTimer) clearTimeout(tapTimer);
  tapTimer = setTimeout(()=>{ tapCount=0; }, 1200);

  if(tapCount >= 7){
    tapCount = 0;
    // buka admin walaupun customerMode ON
    adminQuick();
  }
}

/* =========================
   INIT
========================= */
$("presetSelect").addEventListener("change",(e)=>{
  state.preset = e.target.value;
  persist();
  render();
});

$("playBtn").addEventListener("click", playMusicManual);
$("stopBtn").addEventListener("click", ()=>{
  stopAllAudio();
  $("musicInfo").textContent = "Muzik: Berhenti ‚èπÔ∏è";
});
$("muteBtn").addEventListener("click", ()=>{
  toggleMute();
  $("muteBtn").textContent = isMuted ? "UNMUTE" : "MUTE";
});

$("editBtn").addEventListener("click", openEditor);
$("copyBtn").addEventListener("click", doCopy);
$("shareBtn").addEventListener("click", doShare);
$("newLinkBtn").addEventListener("click", generateNewLink);
$("adminBtn").addEventListener("click", adminQuick);

// Secret admin tap target
$("titleTap").addEventListener("click", secretTap);

$("toastOk").addEventListener("click", ()=>{
  $("toastHint").style.display="none";
  try{ localStorage.setItem(TOAST_KEY,"1"); }catch(e){}
});

// Apply package defaults hard (first load if needed)
applyPackageDefaults(state.package, true);
persist();
render();

// htmlpreview protection
if(isHtmlPreview()){
  showBlocker();
}

// expired protection
if(checkExpired()){
  showExpired();
}
</script>
</body>
</html>
