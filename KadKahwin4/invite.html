<!doctype html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Jemputan Perkahwinan</title>
<style>
  :root{
    --bg:#050505;
    --glass:rgba(0,0,0,.55);
    --line:rgba(255,255,255,.14);
    --txt:#f5f7fb;
    --muted:rgba(245,247,251,.78);
    --shadow:0 28px 70px rgba(0,0,0,.65);
    --a1:#d6b46c; --a2:#f3e2b8; --a3:#b7c6ff;

    /* Background layers */
    --bg1: radial-gradient(900px 550px at 20% 0%, rgba(255,255,255,.10), rgba(0,0,0,.02) 45%, rgba(0,0,0,.65) 80%);
    --bg2: linear-gradient(to bottom, rgba(0,0,0,.15), rgba(0,0,0,.88));
    --bgImg: none; /* optional image */
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: ui-serif, Georgia, "Times New Roman", serif;
    background:var(--bg);
    color:var(--txt);
    min-height:100svh;
    overflow-x:hidden;
  }

  /* Background image layer */
  .bgimg{
    position:fixed; inset:0; z-index:-5;
    background-image: var(--bgImg);
    background-size: cover;
    background-position:center;
    background-repeat:no-repeat;
    filter:saturate(1.05) contrast(1.02);
    display:none;
  }

  /* Background video */
  video.bg{
    position:fixed; inset:0;
    width:100%; height:100%;
    object-fit:cover;
    z-index:-6;
    display:none;
  }

  /* Overlay / themes */
  .overlay{
    position:fixed; inset:0; z-index:-4;
    background: var(--bg1), var(--bg2);
  }

  /* Optional animated gradient */
  .anim{
    position:fixed; inset:0; z-index:-4;
    pointer-events:none;
    display:none;
    background: radial-gradient(900px 700px at 10% 10%, rgba(214,180,108,.18), transparent 55%),
                radial-gradient(900px 700px at 90% 20%, rgba(183,198,255,.16), transparent 55%),
                radial-gradient(900px 700px at 50% 95%, rgba(241,198,198,.14), transparent 55%);
    animation: floatGlow 10s ease-in-out infinite;
  }
  @keyframes floatGlow{
    0%{transform:translate3d(0,0,0) scale(1)}
    50%{transform:translate3d(0,-10px,0) scale(1.02)}
    100%{transform:translate3d(0,0,0) scale(1)}
  }

  /* Tap intro (stabil untuk audio/video Android) */
  .tap{
    position:fixed; inset:0; z-index:50;
    display:flex; align-items:center; justify-content:center;
    background:#000; color:#fff; text-align:center; padding:18px;
  }
  .tap .box{
    width:min(460px, 92vw);
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.45);
    border-radius:22px;
    padding:18px 16px;
    box-shadow: var(--shadow);
    backdrop-filter: blur(12px);
  }
  .tap h2{margin:0 0 6px; font-size:18px; letter-spacing:1px}
  .tap p{margin:0 0 14px; color:rgba(255,255,255,.78); font-size:13px; line-height:1.45}
  .tap button{
    width:100%;
    border:0; border-radius:16px;
    padding:12px 14px;
    font-weight:900;
    letter-spacing:.8px;
    background: linear-gradient(135deg, var(--a1), var(--a2));
    color:#111;
    font-size:15px;
    cursor:pointer;
    -webkit-tap-highlight-color:transparent;
  }

  /* Door */
  .door{
    position:fixed; top:0; height:100%; width:50%;
    background: linear-gradient(135deg, rgba(30,30,30,.95), rgba(0,0,0,.98));
    z-index:40;
    transition: transform 1.55s ease;
    border:1px solid rgba(255,255,255,.08);
  }
  .door.left{left:0; border-right:0}
  .door.right{right:0; border-left:0}
  body.open .door.left{transform: translateX(-103%)}
  body.open .door.right{transform: translateX(103%)}
  body.open .tap{display:none}

  /* Layout */
  .wrap{max-width:860px; margin:0 auto; padding:18px 14px 120px}
  .topbar{
    position:sticky; top:10px; z-index:10;
    display:flex; justify-content:space-between; align-items:center; gap:10px;
    margin-top:10px;
    flex-wrap:wrap;
  }
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 12px; border-radius:999px;
    border:1px solid var(--line);
    background: rgba(0,0,0,.25);
    backdrop-filter: blur(10px);
    box-shadow: 0 10px 26px rgba(0,0,0,.25);
    color: var(--muted);
    font-size:12px;
  }
  .pill strong{color:var(--txt)}
  .pill button, .pill select{
    border:0; background:transparent;
    color:var(--txt); font-weight:900;
    cursor:pointer; font-size:12px;
    outline:none;
    -webkit-tap-highlight-color:transparent;
  }
  .pill select{appearance:none; -webkit-appearance:none}

  .card{
    margin-top:14px;
    border-radius:26px;
    border:1px solid var(--line);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
    box-shadow: var(--shadow);
    backdrop-filter: blur(12px);
    overflow:hidden;
  }
  .hero{padding:22px 18px 16px; text-align:center}
  .badge{
    display:inline-flex; align-items:center; justify-content:center;
    gap:10px; padding:10px 12px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    color: rgba(245,247,251,.80);
    letter-spacing:3px;
    font-size:12px;
  }
  h1{
    margin:14px 0 8px; font-size:34px; letter-spacing:.4px;
    color:transparent;
    background: linear-gradient(135deg, var(--a1), var(--a2));
    -webkit-background-clip:text; background-clip:text;
  }
  .names{margin-top:8px; font-size:20px; line-height:1.35; color: rgba(245,247,251,.92)}
  .subtitle{margin-top:10px; color: rgba(245,247,251,.78); font-size:14px; line-height:1.45}
  .divider{
    width:72px; height:2px; margin:18px auto; border-radius:3px;
    background: linear-gradient(to right, var(--a1), var(--a2), var(--a3));
  }

  .grid{
    padding:14px 16px 18px; border-top:1px solid var(--line);
    display:grid; grid-template-columns:1fr; gap:10px;
  }
  @media(min-width:720px){ .grid{grid-template-columns:1fr 1fr} }
  .item{
    border-radius:18px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.20);
    padding:12px;
  }
  .k{font-size:12px;color:rgba(245,247,251,.70); margin-bottom:4px}
  .v{font-size:15px;line-height:1.45;color:rgba(245,247,251,.93)}

  .countWrap{padding:14px 16px 18px; border-top:1px solid var(--line)}
  .countTitle{text-align:center; color:rgba(245,247,251,.82); font-size:13px; letter-spacing:1.5px; margin-bottom:10px}
  .count{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
  @media(max-width:520px){ .count{grid-template-columns:repeat(2,1fr);} }
  .box{
    border-radius:18px; border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.20);
    padding:12px 10px; text-align:center;
  }
  .num{font-size:22px; font-weight:900}
  .lab{margin-top:4px; font-size:11px; color:rgba(245,247,251,.65); letter-spacing:1.2px}

  .actions{
    padding:14px 16px 18px; border-top:1px solid var(--line);
    display:grid; grid-template-columns:1fr 1fr; gap:10px;
  }
  @media(max-width:520px){ .actions{grid-template-columns:1fr;} }
  .btn{
    border:0; border-radius:18px;
    padding:13px 14px;
    font-weight:900; font-size:15px;
    cursor:pointer;
    background: rgba(0,0,0,.22);
    color:var(--txt);
    border:1px solid rgba(255,255,255,.12);
    display:flex; align-items:center; justify-content:center; gap:10px;
    -webkit-tap-highlight-color:transparent;
  }
  .btn.primary{background: linear-gradient(135deg, var(--a1), var(--a2)); color:#111; border:0}
  .btn:active{transform: translateY(1px)}

  .gallery{padding:14px 16px 18px; border-top:1px solid var(--line)}
  .gallery h3{margin:0 0 10px; text-align:center; font-size:14px; letter-spacing:1.2px; color:rgba(245,247,251,.82)}
  .ggrid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  @media(min-width:720px){ .ggrid{grid-template-columns:repeat(4,1fr)} }
  .gimg{
    width:100%; aspect-ratio:1/1; border-radius:18px;
    object-fit:cover; border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    cursor:pointer;
  }

  .lightbox{position:fixed; inset:0; z-index:60; background: rgba(0,0,0,.78); display:none; align-items:center; justify-content:center; padding:16px}
  .lightbox img{
    width:min(92vw,720px); max-height:82vh; object-fit:contain;
    border-radius:18px; border:1px solid rgba(255,255,255,.14);
    box-shadow: 0 30px 80px rgba(0,0,0,.65);
    background:#000;
  }

  .fab{
    position:fixed; right:14px; bottom:16px; z-index:30;
    display:flex; flex-direction:column; gap:10px;
  }
  .fab button{
    width:54px; height:54px; border-radius:18px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.28);
    color:var(--txt);
    backdrop-filter: blur(10px);
    box-shadow: 0 14px 40px rgba(0,0,0,.35);
    font-size:18px; cursor:pointer;
    -webkit-tap-highlight-color:transparent;
  }

  .foot{
    margin-top:14px;
    text-align:center;
    color:rgba(245,247,251,.62);
    font-size:12px;
    line-height:1.5;
    user-select:none;
  }

  /* Editor panel */
  .editor{
    position:fixed; inset:0; z-index:70;
    background: rgba(0,0,0,.70);
    display:none;
    padding:16px;
    overflow:auto;
  }
  .editor .panel{
    width:min(720px, 100%);
    margin:0 auto;
    border-radius:22px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(15,18,26,.78);
    backdrop-filter: blur(14px);
    box-shadow: 0 24px 80px rgba(0,0,0,.65);
    padding:14px;
  }
  .editor h2{margin:6px 6px 10px; font-size:16px}
  .frow{display:grid; grid-template-columns:1fr; gap:10px; padding:6px}
  @media(min-width:720px){ .frow.two{grid-template-columns:1fr 1fr} }
  .editor label{font-size:12px; color:rgba(245,247,251,.72); display:block; margin:0 0 6px}
  .editor input, .editor textarea, .editor select{
    width:100%;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.28);
    color:var(--txt);
    padding:12px 12px;
    font-size:14px;
    outline:none;
  }
  .editor textarea{min-height:78px; resize:vertical}
  .editor .bar{
    display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; padding:6px;
  }
  @media(max-width:520px){ .editor .bar{grid-template-columns:1fr;} }
  .editor .bar button{
    border:0; border-radius:16px;
    padding:12px 12px;
    font-weight:900;
    cursor:pointer;
    font-size:14px;
    -webkit-tap-highlight-color:transparent;
  }
  .editor .bar .save{background: linear-gradient(135deg, var(--a1), var(--a2)); color:#111}
  .editor .bar .close{background: rgba(255,255,255,.10); color:var(--txt); border:1px solid rgba(255,255,255,.14)}
  .editor .bar .reset{background: rgba(255,255,255,.10); color:var(--txt); border:1px solid rgba(255,255,255,.14)}
  .note{padding:0 6px 10px; color:rgba(245,247,251,.72); font-size:12px; line-height:1.45}

  /* Hide YouTube iframe */
  #ytWrap{position:fixed; left:-9999px; top:-9999px; width:1px; height:1px; overflow:hidden}
</style>
</head>

<body>

<div class="bgimg" id="bgImgLayer"></div>
<video class="bg" id="bgVideo" autoplay muted loop playsinline preload="metadata"></video>
<div class="overlay"></div>
<div class="anim" id="animLayer"></div>

<div class="tap" id="tap">
  <div class="box">
    <h2>JEMPUTAN PERKAHWINAN</h2>
    <p>Tekan untuk buka kad. (Klik ini juga bantu muzik/video jadi stabil di Android.)</p>
    <button onclick="openInvite()">BUKA KAD</button>
  </div>
</div>

<div class="door left"></div>
<div class="door right"></div>

<!-- MP3 audio (paling stabil) -->
<audio id="bgm" loop preload="auto"></audio>

<!-- YouTube audio option -->
<div id="ytWrap">
  <div id="ytPlayer"></div>
</div>

<div class="wrap">
  <div class="topbar">
    <div class="pill">üïí <strong id="clock">--:--</strong> <span style="opacity:.6">‚Ä¢</span> <span id="dayText"></span></div>

    <div class="pill">üé®
      <select id="themeSelect">
        <option value="gold">Gold</option>
        <option value="rose">Rose Gold</option>
        <option value="white">White Elegant</option>
        <option value="emerald">Emerald</option>
        <option value="royal">Royal Blue</option>
        <option value="animated">Animated Glow</option>
      </select>
    </div>

    <div class="pill">üîä <button id="muteBtn" type="button">MUTE</button></div>
    <div class="pill">‚úèÔ∏è <button id="editBtn" type="button">EDIT</button></div>
  </div>

  <div class="card">
    <div class="hero">
      <div class="badge" id="badge">WALIMATULURUS</div>
      <h1 id="title">Jemputan Perkahwinan</h1>

      <div class="names">
        <div id="groom">Nama Pengantin Lelaki</div>
        <div style="opacity:.85;margin:6px 0">‚ô•</div>
        <div id="bride">Nama Pengantin Perempuan</div>
      </div>

      <div class="divider"></div>

      <div class="subtitle" id="inviteText">
        Dengan penuh kesyukuran, kami menjemput anda hadir memeriahkan majlis kami.
      </div>
    </div>

    <div class="grid">
      <div class="item"><div class="k">üìÖ Tarikh</div><div class="v" id="eventDateText">31 Disember 2025</div></div>
      <div class="item"><div class="k">‚è∞ Masa</div><div class="v" id="eventTimeText">9:00 AM ‚Äì 2:00 PM</div></div>
      <div class="item" style="grid-column:1/-1"><div class="k">üìç Lokasi</div><div class="v" id="venueText">Dewan Contoh, Pulau Pinang</div></div>
    </div>

    <div class="countWrap">
      <div class="countTitle">COUNTDOWN MAJLIS</div>
      <div class="count">
        <div class="box"><div class="num" id="cdD">--</div><div class="lab">HARI</div></div>
        <div class="box"><div class="num" id="cdH">--</div><div class="lab">JAM</div></div>
        <div class="box"><div class="num" id="cdM">--</div><div class="lab">MINIT</div></div>
        <div class="box"><div class="num" id="cdS">--</div><div class="lab">SAAT</div></div>
      </div>
    </div>

    <div class="actions">
      <button class="btn primary" id="btnRSVP">üí¨ RSVP WhatsApp</button>
      <button class="btn" id="btnMaps">üìç Buka Maps</button>
      <button class="btn" id="btnCal">üìÖ Add to Calendar</button>
      <button class="btn" id="btnShare">üì§ Share / Copy Link</button>
    </div>

    <div class="gallery">
      <h3>GALERI KAMI</h3>
      <div class="ggrid" id="galleryGrid"></div>
    </div>
  </div>

  <div class="foot">
    Nota: Jangan guna template ini untuk jual semula tanpa kebenaran pemilik.<br>
    ¬© Premium Wedding Card
  </div>
</div>

<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <img id="lightboxImg" alt="Gambar" />
</div>

<div class="fab">
  <button title="Scroll atas" onclick="window.scrollTo({top:0,behavior:'smooth'})">‚¨ÜÔ∏è</button>
  <button title="Scroll bawah" onclick="window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'})">‚¨áÔ∏è</button>
</div>

<!-- EDITOR -->
<div class="editor" id="editor">
  <div class="panel">
    <h2>Mode Edit (Isi macam borang)</h2>
    <div class="note">
      ‚úÖ Untuk muzik paling mudah: guna <b>MP3 direct link</b>.<br>
      ‚úÖ Kalau nak YouTube: paste link YouTube (akan main lepas klik BUKA KAD).<br>
      ‚ö†Ô∏è YouTube ada limit autoplay pada sesetengah telefon ‚Äî normal.
    </div>

    <div class="frow two">
      <div><label>Nama Pengantin Lelaki</label><input id="fGroom" /></div>
      <div><label>Nama Pengantin Perempuan</label><input id="fBride" /></div>
    </div>

    <div class="frow">
      <div><label>Tajuk</label><input id="fTitle" /></div>
      <div><label>Ayat Jemputan</label><textarea id="fInviteText"></textarea></div>
    </div>

    <div class="frow two">
      <div><label>Tarikh (paparan)</label><input id="fDateText" placeholder="31 Disember 2025" /></div>
      <div><label>Masa (paparan)</label><input id="fTimeText" placeholder="9:00 AM ‚Äì 2:00 PM" /></div>
    </div>

    <div class="frow">
      <div><label>Lokasi (paparan)</label><textarea id="fVenueText"></textarea></div>
    </div>

    <div class="frow two">
      <div><label>Start ISO (untuk countdown)</label><input id="fStartISO" placeholder="2025-12-31T09:00:00+08:00" /></div>
      <div><label>End ISO (untuk calendar)</label><input id="fEndISO" placeholder="2025-12-31T14:00:00+08:00" /></div>
    </div>

    <div class="frow two">
      <div><label>No WhatsApp (format 6012xxxxxxx)</label><input id="fPhone" placeholder="60123456789" /></div>
      <div><label>Teks RSVP</label><input id="fRsvpText" /></div>
    </div>

    <div class="frow two">
      <div><label>Maps Link (optional)</label><input id="fMapsLink" placeholder="https://maps.app.goo.gl/xxxx" /></div>
      <div><label>Maps Search (jika tiada link)</label><input id="fMapsQuery" placeholder="Dewan Seri Mutiara, Pulau Pinang" /></div>
    </div>

    <div class="frow two">
      <div><label>üéµ MP3 URL (paling stabil)</label><input id="fAudioMp3" placeholder="https://.../lagu.mp3" /></div>
      <div><label>‚ñ∂Ô∏è YouTube URL (optional)</label><input id="fYouTube" placeholder="https://youtube.com/watch?v=xxxx" /></div>
    </div>

    <div class="frow two">
      <div><label>üé• Video MP4 URL (optional)</label><input id="fVideo" placeholder="https://.../video.mp4" /></div>
      <div><label>üñºÔ∏è Background Image URL (optional)</label><input id="fBgImg" placeholder="https://.../background.jpg" /></div>
    </div>

    <div class="frow two">
      <div>
        <label>üé® Tema Latar (pilih untuk pelanggan)</label>
        <select id="fTheme">
          <option value="gold">Gold</option>
          <option value="rose">Rose Gold</option>
          <option value="white">White Elegant</option>
          <option value="emerald">Emerald</option>
          <option value="royal">Royal Blue</option>
          <option value="animated">Animated Glow</option>
        </select>
      </div>
      <div>
        <label>Animated Glow (ON/OFF)</label>
        <select id="fAnim">
          <option value="1">ON</option>
          <option value="0">OFF</option>
        </select>
      </div>
    </div>

    <div class="frow">
      <div>
        <label>Galeri (1 link per baris)</label>
        <textarea id="fGallery" placeholder="https://.../1.jpg&#10;https://.../2.jpg"></textarea>
      </div>
    </div>

    <div class="bar">
      <button class="close" onclick="closeEditor()">Tutup</button>
      <button class="reset" onclick="resetData()">Reset</button>
      <button class="save" onclick="saveEditor()">Simpan</button>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = "KK_PREMIUM_EDITOR_V2";

  const DEFAULTS = {
    badge: "WALIMATULURUS",
    title: "Jemputan Perkahwinan",
    groom: "Nama Pengantin Lelaki",
    bride: "Nama Pengantin Perempuan",
    inviteText: "Dengan penuh kesyukuran, kami menjemput anda hadir memeriahkan majlis kami.",
    eventDateText: "31 Disember 2025",
    eventTimeText: "9:00 AM ‚Äì 2:00 PM",
    venueText: "Dewan Contoh, Pulau Pinang",
    eventStartISO: "2025-12-31T09:00:00+08:00",
    eventEndISO: "2025-12-31T14:00:00+08:00",
    rsvpPhone: "60123456789",
    rsvpText: "Assalamualaikum/Hi, saya ingin RSVP hadir ke majlis perkahwinan.",

    mapsLink: "",
    mapsQuery: "Dewan Contoh, Pulau Pinang",

    // Media
    audioMp3Url: "",   // mp3 direct
    youTubeUrl: "",    // youtube link
    videoUrl: "",      // mp4 direct
    bgImageUrl: "",    // image url

    // theme/background
    theme: "gold",
    animOn: 0,

    gallery: [
      "https://images.unsplash.com/photo-1523438097201-512ae7d59c30?auto=format&fit=crop&w=900&q=70",
      "https://images.unsplash.com/photo-1529634806980-85c3dd6d34ac?auto=format&fit=crop&w=900&q=70",
      "https://images.unsplash.com/photo-1519225421980-715cb0215aed?auto=format&fit=crop&w=900&q=70",
      "https://images.unsplash.com/photo-1529636798458-92182e662485?auto=format&fit=crop&w=900&q=70"
    ]
  };

  const $ = (id)=>document.getElementById(id);
  let state = loadState();
  let muted = false;
  let cdTimer = null;

  // YouTube player (optional)
  let ytReady = false;
  let ytPlayer = null;
  let ytVideoId = "";

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return {...DEFAULTS};
      const obj = JSON.parse(raw);
      return {...DEFAULTS, ...obj};
    }catch(e){
      return {...DEFAULTS};
    }
  }
  function persist(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function parseYouTubeId(url){
    if(!url) return "";
    const s = String(url).trim();
    if(!s) return "";
    // Accept plain ID
    if(/^[a-zA-Z0-9_-]{11}$/.test(s)) return s;

    try{
      const u = new URL(s);
      if(u.hostname.includes("youtu.be")) return u.pathname.replace("/","");
      if(u.searchParams.get("v")) return u.searchParams.get("v");
      // shorts
      const m = u.pathname.match(/\/shorts\/([a-zA-Z0-9_-]{11})/);
      if(m) return m[1];
    }catch(e){}
    return "";
  }

  function setTheme(theme){
    // Accent + base theme
    const root = document.documentElement.style;

    // Reset to dark defaults first
    root.setProperty("--bg", "#050505");
    root.setProperty("--glass", "rgba(0,0,0,.55)");
    root.setProperty("--line", "rgba(255,255,255,.14)");
    root.setProperty("--txt", "#f5f7fb");
    root.setProperty("--muted", "rgba(245,247,251,.78)");

    // Default overlay layers
    root.setProperty("--bg1", "radial-gradient(900px 550px at 20% 0%, rgba(255,255,255,.10), rgba(0,0,0,.02) 45%, rgba(0,0,0,.65) 80%)");
    root.setProperty("--bg2", "linear-gradient(to bottom, rgba(0,0,0,.15), rgba(0,0,0,.88))");

    if(theme === "rose"){
      root.setProperty("--a1", "#e2a7b5");
      root.setProperty("--a2", "#ffe2ea");
      root.setProperty("--a3", "#f1c6c6");
      root.setProperty("--bg1", "radial-gradient(900px 600px at 25% 0%, rgba(226,167,181,.18), transparent 55%), radial-gradient(900px 600px at 90% 20%, rgba(255,226,234,.14), transparent 55%)");
    }else if(theme === "white"){
      root.setProperty("--bg", "#f6f7fb");
      root.setProperty("--glass", "rgba(255,255,255,.72)");
      root.setProperty("--line", "rgba(0,0,0,.10)");
      root.setProperty("--txt", "#0b0f14");
      root.setProperty("--muted", "rgba(11,15,20,.72)");
      root.setProperty("--a1", "#111827");
      root.setProperty("--a2", "#c7ccd8");
      root.setProperty("--a3", "#8fb3ff");
      root.setProperty("--bg1", "radial-gradient(1000px 650px at 15% 0%, rgba(143,179,255,.22), transparent 55%)");
      root.setProperty("--bg2", "linear-gradient(to bottom, rgba(255,255,255,.65), rgba(246,247,251,.85))");
    }else if(theme === "emerald"){
      root.setProperty("--a1", "#34d399");
      root.setProperty("--a2", "#d1fae5");
      root.setProperty("--a3", "#60a5fa");
      root.setProperty("--bg1", "radial-gradient(900px 600px at 18% 0%, rgba(52,211,153,.20), transparent 55%), radial-gradient(900px 600px at 90% 20%, rgba(96,165,250,.14), transparent 55%)");
    }else if(theme === "royal"){
      root.setProperty("--a1", "#60a5fa");
      root.setProperty("--a2", "#c7d2fe");
      root.setProperty("--a3", "#fca5a5");
      root.setProperty("--bg1", "radial-gradient(900px 600px at 18% 0%, rgba(96,165,250,.22), transparent 55%), radial-gradient(900px 600px at 90% 10%, rgba(199,210,254,.16), transparent 55%)");
    }else if(theme === "animated"){
      // keep gold accents but turn on animated background (handled elsewhere)
      root.setProperty("--a1", "#d6b46c");
      root.setProperty("--a2", "#f3e2b8");
      root.setProperty("--a3", "#b7c6ff");
    }else{
      // gold
      root.setProperty("--a1", "#d6b46c");
      root.setProperty("--a2", "#f3e2b8");
      root.setProperty("--a3", "#b7c6ff");
    }

    localStorage.setItem("kk_theme", theme);
  }

  function setBackgroundImage(url){
    const layer = $("bgImgLayer");
    if(url && url.trim()){
      document.documentElement.style.setProperty("--bgImg", `url("${url.trim()}")`);
      layer.style.display = "block";
    }else{
      document.documentElement.style.setProperty("--bgImg", "none");
      layer.style.display = "none";
    }
  }

  function setAnimated(on){
    $("animLayer").style.display = on ? "block" : "none";
  }

  function tickClock(){
    const d = new Date();
    $("clock").textContent = new Intl.DateTimeFormat(undefined,{hour:"numeric",minute:"2-digit"}).format(d);
    $("dayText").textContent = new Intl.DateTimeFormat(undefined,{weekday:"long", year:"numeric", month:"short", day:"numeric"}).format(d);
  }

  function buildWhatsAppLink(){
    const text = encodeURIComponent(state.rsvpText + " (" + state.groom + " & " + state.bride + ")");
    return "https://wa.me/" + state.rsvpPhone + "?text=" + text;
  }
  function buildMapsLink(){
    if(state.mapsLink && state.mapsLink.trim()) return state.mapsLink.trim();
    return "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(state.mapsQuery || state.venueText);
  }

  function toICSDate(dt){
    const d = new Date(dt);
    const pad = (n)=>String(n).padStart(2,"0");
    return d.getUTCFullYear() + pad(d.getUTCMonth()+1) + pad(d.getUTCDate()) + "T" +
           pad(d.getUTCHours()) + pad(d.getUTCMinutes()) + pad(d.getUTCSeconds()) + "Z";
  }
  function downloadICS(){
    const dtStart = toICSDate(state.eventStartISO);
    const dtEnd = toICSDate(state.eventEndISO);
    const uid = "kk-" + Math.random().toString(16).slice(2) + "@invite";
    const summary = `${state.groom} & ${state.bride} - Majlis Perkahwinan`;
    const location = (state.venueText || "").replace(/\n/g," ");
    const desc = (state.inviteText || "").replace(/\n/g," ");

    const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//KadKahwin//MY//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${toICSDate(new Date())}
DTSTART:${dtStart}
DTEND:${dtEnd}
SUMMARY:${summary}
LOCATION:${location}
DESCRIPTION:${desc}
END:VEVENT
END:VCALENDAR`;

    const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "Majlis-Perkahwinan.ics";
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  function safeCopy(text){
    return navigator.clipboard?.writeText(text).catch(() => {
      const ta = document.createElement("textarea");
      ta.value = text; ta.style.position="fixed"; ta.style.opacity="0";
      document.body.appendChild(ta); ta.focus(); ta.select();
      document.execCommand("copy"); ta.remove();
    });
  }
  function shareLink(){
    const link = location.href;
    if(navigator.share){
      navigator.share({ title: document.title, url: link }).catch(()=>{});
    }else{
      safeCopy(link).then(()=>alert("Link sudah copy."));
    }
  }

  function setupGallery(){
    const grid = $("galleryGrid");
    grid.innerHTML = "";
    (state.gallery || []).forEach((src, idx)=>{
      const img = document.createElement("img");
      img.className = "gimg";
      img.loading = "lazy";
      img.src = src;
      img.alt = "Gambar " + (idx+1);
      img.addEventListener("click", ()=>openLightbox(src));
      grid.appendChild(img);
    });
  }
  function openLightbox(src){
    $("lightboxImg").src = src;
    $("lightbox").style.display = "flex";
  }
  function closeLightbox(){
    $("lightbox").style.display = "none";
  }
  window.closeLightbox = closeLightbox;

  function setVideo(url){
    const v = $("bgVideo");
    if(!url || !url.trim()){
      v.style.display = "none";
      v.innerHTML = "";
      return;
    }
    v.style.display = "block";
    v.innerHTML = `<source src="${url.trim()}" type="video/mp4">`;
    v.muted = true; v.playsInline = true;
    v.addEventListener("loadedmetadata", ()=>v.play().catch(()=>{}), {once:true});
  }

  /* ===== Music ===== */
  function setMp3(url){
    const a = $("bgm");
    if(!url || !url.trim()){
      a.innerHTML = "";
      return;
    }
    a.innerHTML = `<source src="${url.trim()}" type="audio/mpeg">`;
  }

  function stopAllAudio(){
    // stop mp3
    const a = $("bgm");
    try{ a.pause(); a.currentTime = 0; }catch(e){}

    // stop youtube
    if(ytPlayer && ytReady){
      try{ ytPlayer.stopVideo(); }catch(e){}
    }
  }

  function playMusic(){
    // Priority: MP3, else YouTube
    const mp3Ok = state.audioMp3Url && state.audioMp3Url.trim();
    const ytId = parseYouTubeId(state.youTubeUrl);

    if(mp3Ok){
      stopAllAudio();
      const a = $("bgm");
      a.muted = muted;
      a.play().catch(()=>{});
      return;
    }

    if(ytId){
      // load API if needed, then play
      ytVideoId = ytId;
      ensureYouTubeApi(() => {
        loadOrCueYouTube(ytVideoId);
        setTimeout(() => {
          try{
            ytPlayer.setVolume(muted ? 0 : 100);
            ytPlayer.playVideo();
          }catch(e){}
        }, 200);
      });
    }
  }

  function toggleMute(){
    muted = !muted;
    $("muteBtn").textContent = muted ? "UNMUTE" : "MUTE";

    // mp3
    $("bgm").muted = muted;

    // yt
    if(ytPlayer && ytReady){
      try{
        ytPlayer.setVolume(muted ? 0 : 100);
      }catch(e){}
    }
  }

  /* ===== YouTube API handling ===== */
  function ensureYouTubeApi(cb){
    if(window.YT && window.YT.Player){
      ytReady = true;
      cb();
      return;
    }
    // load once
    if(document.getElementById("ytApiScript")){
      // wait until ready
      const wait = setInterval(() => {
        if(window.YT && window.YT.Player){
          clearInterval(wait);
          ytReady = true;
          cb();
        }
      }, 200);
      return;
    }
    const s = document.createElement("script");
    s.id = "ytApiScript";
    s.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(s);

    window.onYouTubeIframeAPIReady = () => {
      ytReady = true;
      cb();
    };
  }

  function loadOrCueYouTube(videoId){
    if(!videoId) return;
    if(!ytPlayer){
      ytPlayer = new YT.Player("ytPlayer", {
        height: "0",
        width: "0",
        videoId,
        playerVars: {
          autoplay: 0,
          controls: 0,
          rel: 0,
          modestbranding: 1,
          playsinline: 1
        },
        events: {
          onReady: () => {
            try{
              ytPlayer.setVolume(muted ? 0 : 100);
            }catch(e){}
          }
        }
      });
    }else{
      try{
        ytPlayer.loadVideoById(videoId);
      }catch(e){}
    }
  }

  function applyState(){
    $("badge").textContent = state.badge;
    $("title").textContent = state.title;
    $("groom").textContent = state.groom;
    $("bride").textContent = state.bride;
    $("inviteText").textContent = state.inviteText;
    $("eventDateText").textContent = state.eventDateText;
    $("eventTimeText").textContent = state.eventTimeText;
    $("venueText").textContent = state.venueText;

    $("btnRSVP").onclick = ()=>window.open(buildWhatsAppLink(), "_blank");
    $("btnMaps").onclick = ()=>window.open(buildMapsLink(), "_blank");
    $("btnCal").onclick = downloadICS;
    $("btnShare").onclick = shareLink;

    // Theme + background
    setTheme(state.theme);
    $("themeSelect").value = state.theme;
    setAnimated(Number(state.animOn) === 1 || state.theme === "animated");
    setBackgroundImage(state.bgImageUrl);

    // Media
    setVideo(state.videoUrl);
    setMp3(state.audioMp3Url);

    setupGallery();

    // Countdown
    if(cdTimer) clearInterval(cdTimer);
    const target = new Date(state.eventStartISO).getTime();
    const upd = ()=>{
      const now = Date.now();
      let diff = target - now;
      if(!isFinite(diff)) diff = 0;
      if(diff < 0) diff = 0;
      const d = Math.floor(diff/(1000*60*60*24));
      const h = Math.floor((diff/(1000*60*60))%24);
      const m = Math.floor((diff/(1000*60))%60);
      const s = Math.floor((diff/1000)%60);
      $("cdD").textContent = String(d).padStart(2,"0");
      $("cdH").textContent = String(h).padStart(2,"0");
      $("cdM").textContent = String(m).padStart(2,"0");
      $("cdS").textContent = String(s).padStart(2,"0");
    };
    upd();
    cdTimer = setInterval(upd, 1000);
  }

  /* Open invite (after tap) */
  function openInvite(){
    document.body.classList.add("open");
    document.body.style.overflowY = "auto";

    // video (silent)
    const v = $("bgVideo");
    if(v && v.style.display !== "none") v.play().catch(()=>{});

    // Start music after user gesture
    playMusic();
  }
  window.openInvite = openInvite;

  /* Editor */
  function openEditor(){
    $("fGroom").value = state.groom;
    $("fBride").value = state.bride;
    $("fTitle").value = state.title;
    $("fInviteText").value = state.inviteText;
    $("fDateText").value = state.eventDateText;
    $("fTimeText").value = state.eventTimeText;
    $("fVenueText").value = state.venueText;
    $("fStartISO").value = state.eventStartISO;
    $("fEndISO").value = state.eventEndISO;
    $("fPhone").value = state.rsvpPhone;
    $("fRsvpText").value = state.rsvpText;
    $("fMapsLink").value = state.mapsLink;
    $("fMapsQuery").value = state.mapsQuery;

    $("fAudioMp3").value = state.audioMp3Url;
    $("fYouTube").value = state.youTubeUrl;
    $("fVideo").value = state.videoUrl;
    $("fBgImg").value = state.bgImageUrl;

    $("fTheme").value = state.theme;
    $("fAnim").value = String(state.animOn);

    $("fGallery").value = (state.gallery || []).join("\n");
    $("editor").style.display = "block";
  }
  function closeEditor(){ $("editor").style.display = "none"; }
  window.closeEditor = closeEditor;

  function saveEditor(){
    const startISO = $("fStartISO").value.trim();
    const endISO = $("fEndISO").value.trim();
    if(isNaN(new Date(startISO).getTime())){
      alert("Start ISO tak sah. Contoh: 2025-12-31T09:00:00+08:00");
      return;
    }
    if(isNaN(new Date(endISO).getTime())){
      alert("End ISO tak sah. Contoh: 2025-12-31T14:00:00+08:00");
      return;
    }

    state.groom = $("fGroom").value.trim() || state.groom;
    state.bride = $("fBride").value.trim() || state.bride;
    state.title = $("fTitle").value.trim() || state.title;
    state.inviteText = $("fInviteText").value.trim() || state.inviteText;
    state.eventDateText = $("fDateText").value.trim() || state.eventDateText;
    state.eventTimeText = $("fTimeText").value.trim() || state.eventTimeText;
    state.venueText = $("fVenueText").value.trim() || state.venueText;
    state.eventStartISO = startISO;
    state.eventEndISO = endISO;

    state.rsvpPhone = $("fPhone").value.trim() || state.rsvpPhone;
    state.rsvpText = $("fRsvpText").value.trim() || state.rsvpText;

    state.mapsLink = $("fMapsLink").value.trim();
    state.mapsQuery = $("fMapsQuery").value.trim() || state.mapsQuery;

    state.audioMp3Url = $("fAudioMp3").value.trim();
    state.youTubeUrl = $("fYouTube").value.trim();
    state.videoUrl = $("fVideo").value.trim();
    state.bgImageUrl = $("fBgImg").value.trim();

    state.theme = $("fTheme").value;
    state.animOn = Number($("fAnim").value);

    const gLines = $("fGallery").value.split("\n").map(s=>s.trim()).filter(Boolean);
    if(gLines.length) state.gallery = gLines;

    persist();
    applyState();

    // restart music choice after save (only if already opened)
    if(document.body.classList.contains("open")){
      playMusic();
    }

    alert("‚úÖ Disimpan. Kad sudah dikemaskini.");
    closeEditor();
  }
  window.saveEditor = saveEditor;

  function resetData(){
    if(confirm("Reset semua data ke default?")){
      localStorage.removeItem(STORAGE_KEY);
      state = loadState();
      applyState();
      stopAllAudio();
      alert("‚úÖ Reset siap.");
      closeEditor();
    }
  }
  window.resetData = resetData;

  /* Init */
  (function init(){
    // initial
    applyState();
    tickClock();
    setInterval(tickClock, 10000);

    $("muteBtn").addEventListener("click", toggleMute);
    $("editBtn").addEventListener("click", openEditor);

    $("themeSelect").addEventListener("change", (e)=>{
      state.theme = e.target.value;
      persist();
      applyState();
    });

    // keep scroll locked until open
    document.body.style.overflowY = "hidden";
  })();
</script>

</body>
</html>
