<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Admin Android (Stabil)</title>
  <style>
    :root{
      --bg:#0b0f14; --card:#131a22; --muted:#a7b0bb; --txt:#e8edf2;
      --line:#223040; --ok:#29d07f; --warn:#ffcc66;
      --btn:#1f2a36; --btn2:#202b3a;
      --accent:#8fb3ff;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 30% 0%, #182433 0%, #0b0f14 60%, #0b0f14 100%);
      color:var(--txt);
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      padding: 18px 14px 36px;
    }
    .wrap{max-width:900px;margin:0 auto}
    .top{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.08);
      border-radius:22px;
      padding:16px 16px 12px;
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      position:sticky; top:12px; z-index:5;
      backdrop-filter: blur(10px);
    }
    .row{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    h1{font-size:22px;margin:0; letter-spacing:.2px}
    .status{
      display:flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      font-weight:700; font-size:12px;
    }
    .dot{width:10px;height:10px;border-radius:50%;background:var(--ok); box-shadow:0 0 0 4px rgba(41,208,127,.12)}
    .sub{margin-top:8px; color:var(--muted); font-size:13px; line-height:1.35}
    .hint{
      margin-top:10px; padding:10px 12px; border-radius:16px;
      border:1px solid rgba(41,208,127,.22);
      background:rgba(41,208,127,.08);
      color:#dff8ea; font-size:13px;
    }

    .grid{display:grid; grid-template-columns:1fr; gap:14px; margin-top:14px}
    @media(min-width:860px){ .grid{grid-template-columns: 1.2fr .8fr;} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.08);
      border-radius:22px;
      padding:14px;
      box-shadow:0 14px 34px rgba(0,0,0,.3);
    }
    .card h2{margin:0 0 10px; font-size:16px; letter-spacing:.2px}
    label{display:block; margin:12px 0 6px; color:var(--muted); font-size:13px}
    input, select, textarea{
      width:100%;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      color:var(--txt);
      padding:12px 12px;
      font-size:15px;
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    input::placeholder, textarea::placeholder{color:rgba(167,176,187,.65)}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media(max-width:520px){ .two{grid-template-columns:1fr;} }

    .btnrow{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px}
    .btnrow3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:12px}
    @media(max-width:520px){ .btnrow3{grid-template-columns:1fr;} }

    .btn{
      border:0; border-radius:18px;
      padding:12px 14px;
      font-size:15px;
      font-weight:800;
      background:var(--btn);
      color:var(--txt);
      cursor:pointer;
      box-shadow:0 10px 22px rgba(0,0,0,.25);
      display:flex; align-items:center; justify-content:center; gap:8px;
      user-select:none; -webkit-tap-highlight-color:transparent;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{background: linear-gradient(135deg, #ffeaa3, #ffd06f); color:#1a1a1a;}
    .btn.secondary{background: linear-gradient(135deg, #b7c6ff, #8fb3ff); color:#0b0f14;}
    .btn.small{padding:10px 12px; font-size:14px; border-radius:16px; background:var(--btn2);}

    .out{
      margin-top:10px;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      word-break:break-all;
      font-size:13px;
      color:#dfe7ef;
    }
    .msg{margin-top:10px; font-size:13px; color:var(--muted); line-height:1.45}
    .warn{
      border:1px solid rgba(255,204,102,.25);
      background:rgba(255,204,102,.08);
      color:#fff1d1;
      padding:10px 12px; border-radius:16px; margin-top:10px;
      font-size:13px;
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .toggleRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      font-size:12px; color:rgba(238,243,247,.78);
    }
  </style>
</head>
<body>
  <div class="wrap">

    <div class="top">
      <div class="row">
        <div>
          <h1>Admin Android (Stabil)</h1>
          <div class="sub">Isi maklumat ‚Üí tekan <b>Simpan</b>. Untuk tetamu tekan <b>Generate</b> dan bagi link <span class="mono">?d=</span>.</div>
        </div>
        <div class="status"><span class="dot"></span> STATUS: OK</div>
      </div>
      <div class="hint">‚úÖ Data disimpan dalam telefon (localStorage). Kalau field degil tak boleh padam, guna butang <b>üßπ Padam Expired</b>.</div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Setup Asas</h2>

        <label>Base URL <b>invite.html</b> (WAJIB)</label>
        <input id="baseUrl" placeholder="https://username.github.io/repo/folder/invite.html" />

        <label>Video Background</label>
        <select id="videoOn">
          <option value="1">ON</option>
          <option value="0">OFF</option>
        </select>

        <label>VIP Lock</label>
        <select id="vipOn">
          <option value="0">OFF</option>
          <option value="1">ON</option>
        </select>

        <label>Kod VIP (jika VIP ON)</label>
        <input id="vipCode" placeholder="Contoh: VIP123" />

        <label>Expired Lock (untuk pembeli)</label>
        <div class="toggleRow">
          <select id="expOn" style="max-width:180px">
            <option value="0">OFF</option>
            <option value="1">ON</option>
          </select>
          <span class="chip">OFF = tak akan tamat (tiada lock)</span>
          <span class="chip">ON = ikut tarikh & masa</span>
        </div>

        <div class="two">
          <div>
            <label>Tarikh Expired ‚Äî format <b>DD/MM/YYYY</b></label>
            <input id="expDate" placeholder="31/12/2025" inputmode="numeric" />
          </div>
          <div>
            <label>Masa Expired (12 jam) ‚Äî optional</label>
            <input id="expTime" placeholder="11:59 PM" />
          </div>
        </div>

        <div class="warn">
          Tip: Kalau Expired ON tapi masa kosong ‚Üí sistem auto set <b>11:59 PM</b>.
        </div>

        <div class="btnrow">
          <button class="btn small" id="copyBase">üìã Copy Base</button>
          <button class="btn small" id="openInvite">üîé Buka invite.html</button>
        </div>

        <div class="btnrow3">
          <button class="btn" id="clearExp">üßπ Padam Expired</button>
          <button class="btn primary" id="save">üíæ Simpan</button>
          <button class="btn secondary" id="gen">‚ö° Generate</button>
        </div>

        <div class="msg" id="msg"></div>
        <div class="out mono" id="out" style="display:none"></div>
        <div class="out mono" id="debug" style="display:none"></div>
      </div>

      <div class="card">
        <h2>Maklumat Kad</h2>

        <label>Nama Pengantin</label>
        <div class="two">
          <input id="groom" placeholder="Nama Pengantin Lelaki" />
          <input id="bride" placeholder="Nama Pengantin Perempuan" />
        </div>

        <label>Tajuk / Ayat Jemputan</label>
        <textarea id="title" placeholder="Jemputan Majlis Perkahwinan"></textarea>

        <div class="two">
          <div>
            <label>Tarikh Majlis (paparan)</label>
            <input id="eventDate" placeholder="31/12/2025" />
          </div>
          <div>
            <label>Masa Majlis (12 jam)</label>
            <input id="eventTime" placeholder="9:00 AM - 2:00 PM" />
          </div>
        </div>

        <label>Lokasi</label>
        <textarea id="venue" placeholder="Dewan / alamat penuh"></textarea>

        <label>Link Video (mp4 direct URL) ‚Äî optional</label>
        <input id="videoSrc" placeholder="https://.../video.mp4" />

        <div class="btnrow">
          <button class="btn small" id="exportBtn">‚¨áÔ∏è Export</button>
          <button class="btn small" id="importBtn">‚¨ÜÔ∏è Import</button>
        </div>

        <div class="out mono" id="io" style="display:none"></div>
        <div class="msg">Export untuk pindah device: Copy JSON ‚Üí simpan ‚Üí Import di phone lain.</div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const KEY = "KK4_ADMIN_STABLE_v2";

  const fields = {
    baseUrl: $("baseUrl"),
    videoOn: $("videoOn"),
    vipOn: $("vipOn"),
    vipCode: $("vipCode"),
    expOn: $("expOn"),
    expDate: $("expDate"),
    expTime: $("expTime"),
    groom: $("groom"),
    bride: $("bride"),
    title: $("title"),
    eventDate: $("eventDate"),
    eventTime: $("eventTime"),
    venue: $("venue"),
    videoSrc: $("videoSrc"),
  };

  const msg = $("msg");
  const out = $("out");
  const debug = $("debug");
  const io = $("io");

  function setMsg(t, good=true){
    msg.textContent = t || "";
    msg.style.color = good ? "rgba(167,176,187,.95)" : "#ffb3b3";
  }

  function normalizeBaseUrl(u){
    return (u || "").trim();
  }

  function parseDDMMYYYY(dateStr){
    const s = (dateStr || "").trim();
    if(!s) return null;
    const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if(!m) return { error: "Tarikh mesti format DD/MM/YYYY" };
    let dd = parseInt(m[1],10), mm = parseInt(m[2],10), yyyy = parseInt(m[3],10);
    if(mm < 1 || mm > 12) return { error: "Bulan mesti 1-12" };
    if(dd < 1 || dd > 31) return { error: "Hari mesti 1-31" };
    const d = new Date(yyyy, mm-1, dd);
    if(d.getFullYear() !== yyyy || d.getMonth() !== (mm-1) || d.getDate() !== dd){
      return { error: "Tarikh tidak sah" };
    }
    return { dd, mm, yyyy };
  }

  function parse12hTime(timeStr){
    const s = (timeStr || "").trim();
    if(!s) return null;
    const m = s.match(/^(\d{1,2})(?::(\d{2}))?\s*([AaPp][Mm])$/);
    if(!m) return { error: "Masa mesti 12 jam: contoh 11:59 PM" };
    let hh = parseInt(m[1],10);
    let min = m[2] ? parseInt(m[2],10) : 0;
    const ap = m[3].toUpperCase();
    if(hh < 1 || hh > 12) return { error: "Jam mesti 1-12" };
    if(min < 0 || min > 59) return { error: "Minit mesti 00-59" };
    if(ap === "PM" && hh !== 12) hh += 12;
    if(ap === "AM" && hh === 12) hh = 0;
    return { hh24: hh, min };
  }

  function buildExpiryMs(expEnabled, expDateStr, expTimeStr){
    if(!expEnabled) return { ms: null };
    const d = parseDDMMYYYY(expDateStr);
    if(!d) return { error: "Expired ON: Tarikh wajib isi" };
    if(d.error) return { error: d.error };

    const t = parse12hTime(expTimeStr);
    if(t && t.error) return { error: t.error };

    const hh = t ? t.hh24 : 23;
    const min = t ? t.min : 59;
    const exp = new Date(d.yyyy, d.mm-1, d.dd, hh, min, 0, 0); // ikut waktu telefon
    return { ms: exp.getTime(), iso: exp.toISOString() };
  }

  function readForm(){
    return {
      baseUrl: normalizeBaseUrl(fields.baseUrl.value),
      videoOn: fields.videoOn.value === "1",
      vipOn: fields.vipOn.value === "1",
      vipCode: (fields.vipCode.value || "").trim(),
      expOn: fields.expOn.value === "1",
      expDate: (fields.expDate.value || "").trim(),
      expTime: (fields.expTime.value || "").trim(),
      groom: (fields.groom.value || "").trim(),
      bride: (fields.bride.value || "").trim(),
      title: (fields.title.value || "").trim(),
      eventDate: (fields.eventDate.value || "").trim(),
      eventTime: (fields.eventTime.value || "").trim(),
      venue: (fields.venue.value || "").trim(),
      videoSrc: (fields.videoSrc.value || "").trim(),
      v: 2
    };
  }

  function writeForm(d){
    fields.baseUrl.value = d.baseUrl || "";
    fields.videoOn.value = d.videoOn ? "1" : "0";
    fields.vipOn.value = d.vipOn ? "1" : "0";
    fields.vipCode.value = d.vipCode || "VIP123";
    fields.expOn.value = d.expOn ? "1" : "0";
    fields.expDate.value = d.expDate || "";
    fields.expTime.value = d.expTime || "";
    fields.groom.value = d.groom || "";
    fields.bride.value = d.bride || "";
    fields.title.value = d.title || "";
    fields.eventDate.value = d.eventDate || "";
    fields.eventTime.value = d.eventTime || "";
    fields.venue.value = d.venue || "";
    fields.videoSrc.value = d.videoSrc || "";
  }

  function save(){
    const data = readForm();
    localStorage.setItem(KEY, JSON.stringify(data));
    setMsg("‚úÖ Disimpan dalam telefon.");
  }

  function load(){
    const raw = localStorage.getItem(KEY);
    if(!raw) return;
    try{ writeForm(JSON.parse(raw)); setMsg("‚úÖ Data dimuatkan."); }catch(e){}
  }

  function base64UrlEncode(str){
    const utf8 = new TextEncoder().encode(str);
    let bin = "";
    utf8.forEach(b => bin += String.fromCharCode(b));
    const b64 = btoa(bin);
    return b64.replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
  }

  function safeCopy(text){
    return navigator.clipboard?.writeText(text).catch(() => {
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position="fixed"; ta.style.opacity="0";
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      document.execCommand("copy");
      ta.remove();
    });
  }

  function clearExpiredHard(){
    // Clear UI
    fields.expOn.value = "0";
    fields.expDate.value = "";
    fields.expTime.value = "";

    // Clear saved data too (so it won't auto-come-back)
    const data = readForm();
    data.expOn = false;
    data.expDate = "";
    data.expTime = "";
    localStorage.setItem(KEY, JSON.stringify(data));

    out.style.display = "none";
    debug.style.display = "none";
    setMsg("‚úÖ Expired sudah dipadam (reset). Tekan Generate untuk link baru.");
  }

  function generate(){
    const data = readForm();

    if(!data.baseUrl){
      setMsg("‚ùå Base URL wajib isi (mesti habis dengan invite.html).", false);
      return;
    }
    if(!/invite\.html(\?.*)?$/i.test(data.baseUrl)){
      setMsg("‚ùå Base URL mesti link penuh ke invite.html", false);
      return;
    }
    if(data.vipOn && !data.vipCode){
      setMsg("‚ùå VIP ON tapi Kod VIP kosong.", false);
      return;
    }

    const exp = buildExpiryMs(data.expOn, data.expDate, data.expTime);
    if(exp.error){
      setMsg("‚ùå " + exp.error, false);
      return;
    }

    const payload = {
      groom: data.groom,
      bride: data.bride,
      title: data.title,
      eventDate: data.eventDate,
      eventTime: data.eventTime,
      venue: data.venue,
      videoOn: data.videoOn ? 1 : 0,
      videoSrc: data.videoSrc,

      vipOn: data.vipOn ? 1 : 0,
      vipCode: data.vipOn ? data.vipCode : "",

      expOn: data.expOn ? 1 : 0,
      expMs: exp.ms,           // null jika OFF
      expIso: exp.iso || null, // debug / rujukan
      ver: 2
    };

    const encoded = base64UrlEncode(JSON.stringify(payload));
    const link = data.baseUrl + (data.baseUrl.includes("?") ? "&" : "?") + "d=" + encoded;

    out.style.display = "block";
    out.textContent = link;

    debug.style.display = "block";
    debug.textContent =
      "VIP: " + (payload.vipOn ? "ON" : "OFF") +
      " | Expired: " + (payload.expOn ? ("ON (" + (payload.expIso || payload.expMs) + ")") : "OFF") +
      " | Video: " + (payload.videoOn ? "ON" : "OFF");

    safeCopy(link).then(() => setMsg("‚úÖ Link baru siap & sudah copy. Buka guna Incognito untuk test."))
                  .catch(() => setMsg("‚úÖ Link siap. Tekan lama untuk copy jika clipboard block.", true));
  }

  $("save").addEventListener("click", save);
  $("gen").addEventListener("click", generate);

  $("clearExp").addEventListener("click", clearExpiredHard);

  $("copyBase").addEventListener("click", () => {
    const b = normalizeBaseUrl(fields.baseUrl.value);
    if(!b){ setMsg("‚ùå Base URL kosong.", false); return; }
    safeCopy(b).then(() => setMsg("‚úÖ Base URL sudah copy."));
  });

  $("openInvite").addEventListener("click", () => {
    const b = normalizeBaseUrl(fields.baseUrl.value);
    if(!b){ setMsg("‚ùå Base URL kosong.", false); return; }
    window.open(b, "_blank");
  });

  $("exportBtn").addEventListener("click", () => {
    const data = readForm();
    io.style.display = "block";
    io.textContent = JSON.stringify(data, null, 2);
    safeCopy(io.textContent).then(() => setMsg("‚úÖ Export siap & sudah copy."));
  });

  $("importBtn").addEventListener("click", () => {
    const txt = prompt("Tampal JSON Export di sini:");
    if(!txt) return;
    try{
      const data = JSON.parse(txt);
      writeForm(data);
      save();
      setMsg("‚úÖ Import berjaya.");
    }catch(e){
      setMsg("‚ùå JSON tidak sah.", false);
    }
  });

  // Auto load
  load();
})();
</script>
</body>
</html>
