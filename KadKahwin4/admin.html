<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Admin Panel • R-E-M</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ color-scheme: dark; }
    body{ background:#050505; }
    .glass{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); }
    .btn{ padding:.9rem 1rem; border-radius:1rem; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); }
    .btn:hover{ background:rgba(255,255,255,.10); }
    .btnPrimary{ background:rgba(255,255,255,.92); color:#111; border-color:rgba(255,255,255,.0); font-weight:800; }
    .btnPrimary:hover{ background:#fff; }
    .field{ width:100%; padding:.95rem 1rem; border-radius:1rem; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); outline:none; }
    .label{ font-size:11px; letter-spacing:.22em; text-transform:uppercase; opacity:.6; margin-bottom:.35rem; }
    .hr{ border-top:1px solid rgba(255,255,255,.10); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    /* elak overlay makan klik */
    .glass, .btn, button, a, input, select, textarea { pointer-events:auto; }
    #app, #loginCard { position: relative; z-index: 2; }
  </style>
</head>

<body class="min-h-screen p-4">
  <div class="max-w-[980px] mx-auto space-y-4">

    <!-- Header -->
    <div class="glass rounded-3xl p-5">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <div class="text-xl font-semibold">Admin Panel</div>
          <div class="text-white/60 text-sm">Edit pelanggan → jana link → copy. VIP boleh lock/unlock versi 4–5.</div>
          <div id="hdrNote" class="text-xs text-white/45 mt-1"></div>
        </div>

        <div class="grid grid-cols-3 sm:flex gap-2">
          <button id="btnChangeAdmin" class="btn w-full">Tukar Admin</button>
          <button id="btnChangeVip" class="btn w-full">Tukar VIP</button>
          <button id="btnLogout" class="btn w-full">Logout</button>
        </div>
      </div>
    </div>

    <!-- Login card -->
    <div id="loginCard" class="glass rounded-3xl p-5 space-y-3 hidden">
      <div class="text-lg font-semibold">Masukkan password admin</div>
      <input id="passInput" type="password" class="field" placeholder="Password Admin" />
      <button id="btnLogin" class="btnPrimary w-full">Masuk</button>
      <div id="loginMsg" class="text-sm text-red-300"></div>
      <div class="text-xs text-white/50">
        Default Admin: <span class="mono">123456</span> • Default VIP: <span class="mono">vip123456</span>
      </div>
    </div>

    <!-- App -->
    <div id="app" class="glass rounded-3xl p-5 hidden">
      <div class="grid md:grid-cols-2 gap-4">

        <!-- Left -->
        <div class="space-y-3">
          <div class="flex items-center justify-between gap-2">
            <div>
              <div class="label">Pelanggan</div>
              <div class="text-lg font-semibold">Senarai</div>
            </div>
            <div class="flex gap-2">
              <button id="btnNew" class="btn">+ Baru</button>
              <button id="btnRename" class="btn">Rename</button>
              <button id="btnDelete" class="btn">Padam</button>
            </div>
          </div>

          <select id="customerSelect" class="field"></select>

          <div class="hr"></div>

          <div class="label">VIP untuk pelanggan ini</div>
          <div class="grid grid-cols-2 gap-2">
            <button id="btnVipUnlock" class="btn">Unlock VIP</button>
            <button id="btnVipLock" class="btn">Lock VIP</button>
          </div>

          <div id="vipStatus" class="text-xs text-white/55"></div>

          <div class="hr"></div>

          <div class="label">Backup</div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
            <button id="btnExport" class="btn w-full">Export JSON</button>
            <label class="btn cursor-pointer w-full text-center">
              Import JSON
              <input id="importFile" type="file" accept="application/json" class="hidden">
            </label>
            <button id="btnResetAll" class="btn w-full">Reset Semua</button>
          </div>

          <div class="text-xs text-white/45">
            Data simpan dalam <span class="mono">localStorage</span> (device ini). Jika buka pada phone lain, data berbeza.
          </div>
        </div>

        <!-- Right -->
        <div class="space-y-3">
          <div>
            <div class="label">Maklumat Majlis</div>
            <div class="text-lg font-semibold">Edit</div>
          </div>

          <div>
            <div class="label">Base URL (auto)</div>
            <input id="baseUrl" class="field mono" placeholder="Auto: https://.../KadKahwin4/" />
            <div class="text-xs text-white/45 mt-1">Biarkan auto. Kalau link pelik, paste URL folder KadKahwin4 anda.</div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <div class="label">Nama Pengantin</div>
              <input id="names" class="field" placeholder="Adam & Hawa" />
            </div>
            <div>
              <div class="label">WhatsApp (60...)</div>
              <input id="wa" class="field mono" placeholder="60123456789" />
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <div class="label">Tarikh</div>
              <input id="date" class="field" placeholder="Sabtu, 12 Oktober 2025" />
            </div>
            <div>
              <div class="label">Masa</div>
              <input id="time" class="field" placeholder="11.00 pagi – 4.00 petang" />
            </div>
          </div>

          <div>
            <div class="label">Lokasi</div>
            <input id="location" class="field" placeholder="Dewan Seri Melur" />
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <div class="label">Google Maps URL (optional)</div>
              <input id="maps" class="field mono" placeholder="https://maps.google.com/..." />
            </div>
            <div>
              <div class="label">Music URL (optional)</div>
              <input id="music" class="field mono" placeholder="https://.../song.mp3" />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <button id="btnSave" class="btnPrimary w-full">Simpan</button>
            <button id="btnOpenInvite" class="btn w-full">Preview</button>
          </div>

          <div class="hr"></div>

          <div>
            <div class="label">Jana Link Versi</div>
            <div id="links" class="space-y-2"></div>
            <div class="text-xs text-white/45 mt-2">
              *Versi 4–5 hanya keluar jika pelanggan ini “VIP Unlocked”.
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="text-center text-xs text-white/35 select-none">
      © R-E-M Digital Invitation • Admin
    </div>

  </div>

<script>
(function(){
  /* =========================
     STORAGE KEYS
  ========================= */
  const LS_ADMIN_PASS = "REM_ADMIN_PASS_V1";
  const LS_ADMIN_OK   = "REM_ADMIN_OK_V1";
  const LS_VIP_PASS   = "REM_VIP_PASS_V1";
  const LS_CUSTOMERS  = "REM_CUSTOMERS_V1";

  /* =========================
     DEFAULTS (sekali sahaja)
  ========================= */
  if(!localStorage.getItem(LS_ADMIN_PASS)) localStorage.setItem(LS_ADMIN_PASS, "123456");
  if(!localStorage.getItem(LS_VIP_PASS))   localStorage.setItem(LS_VIP_PASS, "vip123456");

  /* =========================
     HELPERS
  ========================= */
  const $ = (id)=>document.getElementById(id);

  function toast(msg){ alert(msg); }

  // bypass cache bila test: tambah ?x=1
  function getBaseUrlAuto(){
    const url = new URL(location.href);
    url.hash = ""; url.search = "";
    url.pathname = url.pathname.replace(/\/[^\/]*$/, "/"); // buang admin.html
    return url.toString();
  }

  function loadCustomers(){
    try{ return JSON.parse(localStorage.getItem(LS_CUSTOMERS) || "[]"); }
    catch(e){ return []; }
  }
  function saveCustomers(list){
    localStorage.setItem(LS_CUSTOMERS, JSON.stringify(list));
  }

  function uid(){
    return "C" + Math.random().toString(16).slice(2,10) + Date.now().toString(16);
  }

  function currentForm(){
    return {
      baseUrl: ($("baseUrl").value || "").trim(),
      names: ($("names").value || "").trim(),
      wa: ($("wa").value || "").trim().replace(/\s+/g,""),
      date: ($("date").value || "").trim(),
      time: ($("time").value || "").trim(),
      location: ($("location").value || "").trim(),
      maps: ($("maps").value || "").trim(),
      music: ($("music").value || "").trim(),
    };
  }

  function fillForm(c){
    $("baseUrl").value = c.baseUrl || getBaseUrlAuto();
    $("names").value = c.names || "";
    $("wa").value = c.wa || "";
    $("date").value = c.date || "";
    $("time").value = c.time || "";
    $("location").value = c.location || "";
    $("maps").value = c.maps || "";
    $("music").value = c.music || "";
  }

  function renderSelect(list, selectedId){
    const sel = $("customerSelect");
    sel.innerHTML = "";
    if(list.length === 0){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Tiada pelanggan (klik + Baru)";
      sel.appendChild(opt);
      sel.disabled = true;
      return;
    }
    sel.disabled = false;
    for(const c of list){
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.label || c.names || c.id;
      sel.appendChild(opt);
    }
    sel.value = selectedId || list[0].id;
  }

  function encodePayload(obj){
    // base64 safe
    return btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
  }

  function buildInviteUrl(version, data){
    const base = (data.baseUrl || getBaseUrlAuto()).replace(/\/?$/, "/");
    const payload = encodePayload(data);
    return `${base}invite.html?v=${version}&c=${encodeURIComponent(payload)}`;
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      toast("✅ Copy berjaya");
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = text; document.body.appendChild(ta);
      ta.select(); document.execCommand("copy");
      ta.remove();
      toast("✅ Copy berjaya");
    }
  }

  function setVipStatus(isVip){
    $("vipStatus").innerHTML = isVip
      ? 'Status: <b class="text-emerald-300">VIP Unlocked</b> (Versi 1–5)'
      : 'Status: <b class="text-amber-300">Normal</b> (Versi 1–3 sahaja)';
  }

  function renderLinks(data, isVip){
    const wrap = $("links");
    wrap.innerHTML = "";
    const maxV = isVip ? 5 : 3;

    for(let v=1; v<=maxV; v++){
      const url = buildInviteUrl(v, data);
      const card = document.createElement("div");
      card.className = "glass rounded-2xl p-3 flex items-center justify-between gap-2";

      const left = document.createElement("div");
      left.className = "min-w-0";
      left.innerHTML = `<div class="text-sm font-semibold">Versi ${v}</div>
                        <div class="text-xs text-white/55 mono truncate">${url}</div>`;

      const right = document.createElement("div");
      right.className = "flex gap-2 shrink-0";

      const btnCopy = document.createElement("button");
      btnCopy.className = "btn";
      btnCopy.textContent = "Copy";
      btnCopy.addEventListener("click", ()=>copyText(url));

      const btnOpen = document.createElement("button");
      btnOpen.className = "btn";
      btnOpen.textContent = "Buka";
      btnOpen.addEventListener("click", ()=>window.open(url, "_blank"));

      right.appendChild(btnCopy);
      right.appendChild(btnOpen);

      card.appendChild(left);
      card.appendChild(right);
      wrap.appendChild(card);
    }
  }

  /* =========================
     LOGIN UI
  ========================= */
  function showLogin(){
    $("loginCard").classList.remove("hidden");
    $("app").classList.add("hidden");
  }
  function showApp(){
    $("loginCard").classList.add("hidden");
    $("app").classList.remove("hidden");
  }

  function doLogin(pass){
    const real = localStorage.getItem(LS_ADMIN_PASS);
    if(pass !== real){
      $("loginMsg").textContent = "Password salah.";
      return false;
    }
    localStorage.setItem(LS_ADMIN_OK, "1");
    $("loginMsg").textContent = "";
    return true;
  }

  function requireLogin(){
    if(localStorage.getItem(LS_ADMIN_OK) === "1") return true;
    showLogin();
    return false;
  }

  /* =========================
     APP LOGIC
  ========================= */
  let LIST = [];
  let CURRENT_ID = "";

  function ensureDefault(){
    LIST = loadCustomers();
    if(!LIST.length){
      const c = {
        id: uid(),
        label: "Default",
        vipUnlocked: false,
        baseUrl: getBaseUrlAuto(),
        names: "Adam & Hawa",
        wa: "601111661303",
        date: "Sabtu, 12 Oktober 2025",
        time: "11.00 pagi – 4.00 petang",
        location: "Dewan Seri Melur",
        maps: "",
        music: ""
      };
      LIST = [c];
      saveCustomers(LIST);
    }
  }

  function getCurrent(){
    ensureDefault();
    if(!CURRENT_ID || !LIST.some(x=>x.id===CURRENT_ID)) CURRENT_ID = LIST[0].id;
    return LIST.find(x=>x.id===CURRENT_ID) || LIST[0];
  }

  function refresh(){
    LIST = loadCustomers();
    ensureDefault();
    LIST = loadCustomers();

    const c = getCurrent();
    renderSelect(LIST, CURRENT_ID);
    fillForm(c);

    const isVip = !!c.vipUnlocked;
    setVipStatus(isVip);
    renderLinks(currentForm(), isVip);

    $("hdrNote").textContent = `Admin default: 123456 (VIP password disembunyikan ✅)`;
  }

  function saveCurrent(){
    const data = currentForm();
    if(!data.names) return toast("Isi Nama Pengantin dulu.");
    if(!data.wa) return toast("Isi nombor WhatsApp (contoh: 60123456789).");

    const idx = LIST.findIndex(x=>x.id===CURRENT_ID);
    const label = (data.names || "Pelanggan").slice(0,32);

    const keepVip = (idx>=0 ? !!LIST[idx].vipUnlocked : false);
    const saved = { ...data, id: CURRENT_ID, label, vipUnlocked: keepVip };

    if(idx>=0) LIST[idx] = saved;
    else LIST.unshift(saved);

    saveCustomers(LIST);
    refresh();
    toast("✅ Disimpan");
  }

  function newCustomer(){
    const data = currentForm();
    const fresh = {
      ...data,
      id: uid(),
      label: "Pelanggan Baru",
      vipUnlocked: false
    };
    LIST.unshift(fresh);
    saveCustomers(LIST);
    CURRENT_ID = fresh.id;
    refresh();
    toast("✅ Pelanggan baru dibuat");
  }

  function renameCustomer(){
    const idx = LIST.findIndex(x=>x.id===CURRENT_ID);
    if(idx<0) return;
    const name = prompt("Nama label pelanggan (contoh: Ali & Siti):", LIST[idx].label || "");
    if(!name) return;
    LIST[idx].label = name.slice(0,40);
    saveCustomers(LIST);
    refresh();
    toast("✅ Rename berjaya");
  }

  function deleteCustomer(){
    if(LIST.length<=1) return toast("Tak boleh padam yang terakhir.");
    const ok = confirm("Padam pelanggan ini?");
    if(!ok) return;
    LIST = LIST.filter(x=>x.id!==CURRENT_ID);
    saveCustomers(LIST);
    CURRENT_ID = LIST[0].id;
    refresh();
    toast("✅ Dipadam");
  }

  function exportJson(){
    const data = JSON.stringify(loadCustomers(), null, 2);
    const blob = new Blob([data], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "rem_customers_backup.json";
    a.click();
  }

  async function importJson(file){
    if(!file) return;
    const text = await file.text();
    try{
      const arr = JSON.parse(text);
      if(!Array.isArray(arr)) throw new Error("not array");
      saveCustomers(arr);
      CURRENT_ID = arr[0]?.id || "";
      refresh();
      toast("✅ Import berjaya");
    }catch(e){
      toast("❌ File JSON tidak sah");
    }
  }

  function resetAll(){
    const ok = confirm("Reset semua data pelanggan + logout? (tidak boleh undo)");
    if(!ok) return;
    localStorage.removeItem(LS_CUSTOMERS);
    localStorage.removeItem(LS_ADMIN_OK);
    toast("✅ Reset siap");
    location.href = "./index.html";
  }

  /* =========================
     PASSWORDS + VIP LOCK
  ========================= */
  function changeAdminPassword(){
    const oldP = prompt("Password Admin lama:");
    if(oldP !== localStorage.getItem(LS_ADMIN_PASS)) return toast("Password lama salah");
    const newP = prompt("Password Admin baru (min 6):");
    if(!newP || newP.length < 6) return toast("Password baru terlalu pendek");
    localStorage.setItem(LS_ADMIN_PASS, newP);
    toast("✅ Admin password berjaya ditukar");
  }

  function changeVipPassword(){
    const oldP = prompt("Password VIP lama:");
    if(oldP !== localStorage.getItem(LS_VIP_PASS)) return toast("Password VIP lama salah");
    const newP = prompt("Password VIP baru (min 6):");
    if(!newP || newP.length < 6) return toast("Password VIP baru terlalu pendek");
    localStorage.setItem(LS_VIP_PASS, newP);
    toast("✅ VIP password berjaya ditukar");
  }

  function vipUnlock(){
    const pass = prompt("Masukkan Password VIP:");
    if(pass !== localStorage.getItem(LS_VIP_PASS)) return toast("❌ VIP password salah");
    LIST = loadCustomers();
    const idx = LIST.findIndex(x=>x.id===CURRENT_ID);
    if(idx<0) return;
    LIST[idx].vipUnlocked = true;
    saveCustomers(LIST);
    toast("✅ VIP di-unlock (Versi 1–5)");
    refresh();
  }

  function vipLock(){
    if(!confirm("Lock VIP untuk pelanggan ini? (Versi 4–5 akan hilang)")) return;
    LIST = loadCustomers();
    const idx = LIST.findIndex(x=>x.id===CURRENT_ID);
    if(idx<0) return;
    LIST[idx].vipUnlocked = false;
    saveCustomers(LIST);
    toast("✅ VIP telah di-lock (Versi 1–3)");
    refresh();
  }

  function logout(){
    localStorage.removeItem(LS_ADMIN_OK);
    toast("Logout");
    location.href = "./index.html";
  }

  /* =========================
     BIND EVENTS (ANTI-MATI)
  ========================= */
  function bind(id, fn){
    const el = $(id);
    if(!el) return;
    el.addEventListener("click", fn);
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    $("baseUrl").value = getBaseUrlAuto();

    // login
    bind("btnLogin", ()=>{
      const pass = $("passInput").value || "";
      if(doLogin(pass)){
        showApp();
        refresh();
      }
    });

    // top buttons
    bind("btnChangeAdmin", ()=>changeAdminPassword());
    bind("btnChangeVip", ()=>changeVipPassword());
    bind("btnLogout", ()=>logout());

    // app actions
    bind("btnSave", ()=>saveCurrent());
    bind("btnNew", ()=>newCustomer());
    bind("btnRename", ()=>renameCustomer());
    bind("btnDelete", ()=>deleteCustomer());

    bind("btnVipUnlock", ()=>vipUnlock());
    bind("btnVipLock", ()=>vipLock());

    bind("btnExport", ()=>exportJson());
    bind("btnResetAll", ()=>resetAll());

    const sel = $("customerSelect");
    if(sel){
      sel.addEventListener("change", ()=>{
        CURRENT_ID = sel.value;
        refresh();
      });
    }

    bind("btnOpenInvite", ()=>{
      const c = getCurrent();
      const url = buildInviteUrl(1, { ...currentForm() });
      window.open(url, "_blank");
    });

    const imp = $("importFile");
    if(imp){
      imp.addEventListener("change", async (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        await importJson(file);
        e.target.value = "";
      });
    }

    // live update links
    ["baseUrl","names","wa","date","time","location","maps","music"].forEach(id=>{
      const el = $(id);
      if(el){
        el.addEventListener("input", ()=>{
          const c = getCurrent();
          renderLinks(currentForm(), !!c.vipUnlocked);
        });
      }
    });

    // boot
    if(requireLogin()){
      showApp();
      refresh();
    }
  });

  // kalau ada error besar, bagi alert (senang detect)
  window.addEventListener("error", (e)=>{
    alert("JS Error: " + (e.message || "unknown"));
  });
})();
</script>
</body>
</html>
